<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Chat v2 - denki</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  font-family:
    -apple-system,
    BlinkMacSystemFont,
    "Segoe UI",
    "Hiragino Kaku Gothic ProN",
    "Hiragino Sans",
    "Noto Sans JP",
    Meiryo,
    sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

#login, #chat { flex: 1; display: flex; flex-direction: column; }
#chat { display: none; }

.system { color: gray; }
.system.girl { color: red; font-weight: bold; }
.system.boy { color: blue; font-weight: bold; }

#controls { display: flex; gap: 5px; padding: 5px; position: sticky; top: 0; background: #fff; z-index: 10; }
input, button, select { padding: 10px; font-size: 16px; }
#punishWrap {
  gap: 20px;   /* ãƒœã‚¿ãƒ³åŒå£«ã®é–“éš” */

  position: absolute;
  bottom: 100%;
  left: 0;
  right: 0;

  background: #fff;
  padding: 8px;
  z-index: 200;
}
#punishWrap button {
  padding: 6px 12px;  /* ãƒœã‚¿ãƒ³ã®ä¸­ã®ä½™ç™½ */
  font-size: 16px;   /* æ–‡å­—ã‚µã‚¤ã‚º */
}


#userList {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  background: #f0f0f0;
  padding: 5px;
  list-style: none;
  align-items: center;
}

#userList li {
  padding: 3px 8px;
  border-radius: 5px;
  white-space: nowrap;
}


#settings { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; padding: 5px; background: #f9f9f9; border-bottom: 1px solid #ccc; }
#settings input, #settings button, #settings select { padding: 5px; font-size: 14px; }

#messages {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  padding: 10px;
  list-style: none;
  padding-bottom: 260px;
}
#messages li { margin-bottom: 5px; }
.private { background: #fff3cd; padding: 3px 6px; border-radius: 4px; }

.time { opacity: .6; margin-right: 4px; }

/* ===== é›»æ°—æ¤…å­UI ===== */
#denkiWrap {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;

  margin: 0;
  padding: 10px;
  background: #e8f5fb;
  border-radius: 8px 8px 0 0;

  display: none;
  z-index: 50;
}


#denkiHeader {
  font-weight: bold;
  margin-bottom: 6px;
}
#denkiStatus {
  margin-bottom: 6px;
}
#denkiBoard {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 8px;
}
#denkiBoard button {
  width: 44px;
  
}
#denkiScore {
  font-size: 14px;
  margin-bottom: 6px;
}
#bottomUI {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;

  background: #fff;
  border-top: 1px solid #ccc;

  padding: 8px;
  z-index: 100;
}

</style>
</head>
<body>

<div id="login">
  <h2>å…¥å®¤</h2>

  <div id="roomInfo"
       style="margin-bottom:10px; color:#555;">
  </div>

  <!-- ===== ãƒ«ãƒ¼ãƒ«èª¬æ˜ ===== -->
<div style="
  margin-top:14px;
  padding:10px;
  font-size:13px;
  line-height:1.6;
  background:#f5f5f5;
  border:1px solid #ccc;
">

<strong>åˆ©ç”¨ãƒ«ãƒ¼ãƒ«</strong><br><br>

<div id="roomDesc"
     style="
       margin-bottom:12px;
       white-space:pre-wrap;
       font-size:13px;
       line-height:1.6;
     ">
</div>

</div>


  <input id="nameInput"
         placeholder="åå‰">

  <!-- ===== ç¢ºèªãƒã‚§ãƒƒã‚¯ ===== -->
  <div style="
    margin-top:12px;
    font-size:14px;
    line-height:1.6;
  ">

    <label>
      <input type="checkbox"
             id="confirmAge">
      18æ­³æœªæº€ã®åˆ©ç”¨ã¯ç¦æ­¢ã§ã™
    </label>
    <br>

    <label>
      <input type="checkbox"
             id="confirmRule">
      ãƒ«ãƒ¼ãƒ«ãƒ»ç¦æ­¢äº‹é …ã‚’ç¢ºèªã—ã¾ã—ãŸ
    </label>
    <br>

    <label>
      <input type="checkbox"
             id="confirmIp">
      IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ä¿ç®¡ã•ã‚Œã€
      å•é¡Œç™ºç”Ÿæ™‚ã¯é–‹ç¤ºã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
    </label>


  </div>

  <button id="joinBtn"
          style="margin-top:12px;">
    å…¥å®¤
  </button>
</div>

<div id="chat">
 <div id="controls">
  <input id="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
  <button id="sendBtn">é€ä¿¡</button>

  <span id="roomLabel"
    style="padding:10px; font-weight:bold;">
  </span>
</div>


  <!-- âš¡ é›»æ°—æ¤…å­ï¼ˆdenki ãƒ«ãƒ¼ãƒ ã®ã¿è¡¨ç¤ºï¼‰ -->
  <div id="denkiWrap">
   
  <!-- ===== ç½°ï¼‹ã‚¿ã‚¤ãƒãƒ¼ï¼ˆé›»æ°—æ¤…å­ç”¨ï¼‰ ===== -->
<div id="denkiPunishArea" style="margin-bottom:10px;">

  <!-- ãƒˆã‚°ãƒ«ï¼‹ã‚¿ã‚¤ãƒãƒ¼ -->
  <div style="display:flex; gap:8px; flex-wrap:wrap;">
    <button id="denkiPunishToggleBtn">ç½°ãƒ¡ãƒ‹ãƒ¥ãƒ¼</button>

    <button id="denkiTimer3Btn">3åˆ†</button>
    <button id="denkiTimer5Btn">5åˆ†</button>

    <input id="denkiTimerCustomInput"
      type="number"
      min="1"
      step="1"
      placeholder="åˆ†"
      style="width:60px;">

    <button id="denkiTimerCustomBtn">ä»»æ„</button>
  </div>

  <!-- ç½°ãƒœã‚¿ãƒ³ -->
  <div id="denkiPunishWrap" style="
  display:none;
  gap:7px;
  flex-wrap:wrap;
  padding:6px 0;
">

    <button onclick="sendPunish('å¥³å­ç½°')">å¥³å­ç½°</button>

    <button id="denkiBoyPunishBtn"
      onclick="sendPunish('ç”·å­ç½°')">
      ç”·å­ç½°
    </button>

    <button onclick="sendPunish('å‘½ä»¤å¥³')">å¥³ã‚ªãƒŠ</button>

    <button id="denkiBoyOnaBtn"
      onclick="sendPunish('å‘½ä»¤ç”·')">
      ç”·ã‚ªãƒŠ
    </button>

    <button id="denkiPainPunishBtn"
      onclick="sendPunish('è‹¦ç—›ç½°')">
      è‹¦ç—›ç½°
    </button>

    <button id="denkiZecchoBtn"
      onclick="sendPunish('çµ¶é ‚è¨±å¯')"
      style="display:none;">
      çµ¶é ‚è¨±å¯
    </button>

</div>

</div>  
    <!-- ===== é›»æ°—æ¤…å­ ç‚¹æ•°è¡¨ ===== -->
<table id="denkiTable" style="
  width:100%;
  border-collapse:collapse;
  margin-bottom:10px;
  font-size:14px;
">
  <thead>
    <tr>
      <th style="border:1px solid #999;">åå‰</th>
      <th style="border:1px solid #999;">1</th>
      <th style="border:1px solid #999;">2</th>
      <th style="border:1px solid #999;">3</th>
      <th style="border:1px solid #999;">4</th>
      <th style="border:1px solid #999;">5</th>
      <th style="border:1px solid #999;">6</th>
      <th style="border:1px solid #999;">7</th>
      <th style="border:1px solid #999;">8</th>
      <th style="border:1px solid #999;">9</th>
      <th style="border:1px solid #999;">åˆè¨ˆ</th>
    </tr>
  </thead>
  <tbody>
    <tr id="denkiRowA">
      <td style="border:1px solid #999;">A</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">0</td>
    </tr>
    <tr id="denkiRowB">
      <td style="border:1px solid #999;">B</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">0</td>
    </tr>
  </tbody>
</table>

    <div id="denkiStatus">å¾…æ©Ÿä¸­</div>
    <div id="denkiScore"></div>
    <div id="denkiBoard"></div>
    <button id="denkiJoinBtn">å‚åŠ </button>
<button id="denkiSetBtn">ä»•æ›ã‘ã‚‹</button>
<button id="denkiShockBtn">âš¡ é›»æµæµã™</button>
<button id="denkiSitBtn">åº§ã‚‹</button>
<button id="denkiConfirmBtn">æ±ºå®š</button>





  </div>
<!-- ===== å‚åŠ è€… ===== -->
<div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
  <strong>å‚åŠ è€…:</strong>
  <ul id="userList"></ul>
</div>



<div id="timerDisplay"
     style="
       font-weight:bold;
       padding:4px 0;
       display:none;">
  â± 00:00
</div>

<div id="settings">

    <label>è‰²: <input type="color" id="colorSelect" value="#000000"></label>
    <label>å†…ç·’:
      <select id="privateTarget">
        <option value="">ãªã—</option>
      </select>
    </label>
    <label>
      éŸ³:
      <select id="soundSelect">
        <option value="off">OFF</option>
        <option value="small">å°</option>
        <option value="medium">ä¸­</option>
        <option value="large">å¤§</option>
      </select>
    </label>
    <button id="ruleBtn">èª¬æ˜</button>
    <button id="leaveBtn">é€€å‡º</button>
  </div>

  <ul id="messages"></ul>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

const login = document.getElementById("login");
const chat = document.getElementById("chat");
const joinBtn = document.getElementById("joinBtn");
const nameInput = document.getElementById("nameInput");
const roomInfo = document.getElementById("roomInfo");

const messages = document.getElementById("messages");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const leaveBtn = document.getElementById("leaveBtn");
const userList = document.getElementById("userList");
const colorSelect = document.getElementById("colorSelect");
const privateTarget = document.getElementById("privateTarget");
const soundSelect = document.getElementById("soundSelect");

const notifySound = new Audio("/notify.mp3");
const SOUND_LEVELS = { off:0, small:0.2, medium:0.5, large:1.0 };
let soundLevel = localStorage.getItem("soundLevel") || "off";
soundSelect.value = soundLevel;

let username = "";
let myColor = "#000000";
let privateTo = "";
let joined = false;

/* ===== é›»æ°—æ¤…å­DOM ===== */
const denkiWrap = document.getElementById("denkiWrap");
const denkiStatus = document.getElementById("denkiStatus");
const denkiBoard = document.getElementById("denkiBoard");
const denkiScore = document.getElementById("denkiScore");
const denkiShockBtn = document.getElementById("denkiShockBtn");
const denkiSetBtn = document.getElementById("denkiSetBtn");
denkiSetBtn.disabled = true;
denkiShockBtn.disabled = true;
const denkiSitBtn = document.getElementById("denkiSitBtn");
denkiSitBtn.disabled = true;
const denkiJoinBtn = document.getElementById("denkiJoinBtn");

const denkiConfirmBtn =
  document.getElementById("denkiConfirmBtn");

denkiConfirmBtn.disabled = true;

denkiConfirmBtn.onclick = () => {

  if (!denkiState) return;
  if (selectedSeat === null) return;

  socket.emit("denkiSitConfirm");

  denkiConfirmBtn.disabled = true;
  selectedSeat = null;

};


denkiJoinBtn.onclick = () => {
  socket.emit("denkiJoin");
};




 let denkiState = {};
let myId = null;
let selectedSeat = null; // â˜… ä»•æ›ã‘ç”¨ã«ä¸€æ™‚ä¿å­˜
denkiShockBtn.onclick = () => {
  socket.emit("denkiShock");
};
denkiSetBtn.onclick = () => {
  if (selectedSeat !== null) {
    socket.emit("denkiSet", selectedSeat);
    selectedSeat = null;
  }
};
denkiSitBtn.onclick = () => {

  if (!denkiState) return;
  if (selectedSeat === null) return;

  // â˜… ã“ã“ã§ã¯é€ä¿¡ã—ãªã„
  // æ±ºå®šãƒœã‚¿ãƒ³ã§é€ä¿¡ã™ã‚‹

  const confirmBtn =
    document.getElementById("denkiConfirmBtn");

  if (confirmBtn){
    confirmBtn.disabled = false;
  }

  denkiSitBtn.disabled = true;

};




/* æ¤…å­12å€‹ */
for (let i = 1; i <= 12; i++) {
  const b = document.createElement("button");
  b.textContent = i;
  b.onclick = () => onDenkiSelect(i);
  denkiBoard.appendChild(b);
}
window.addEventListener("load", () => {
  const savedName  = localStorage.getItem("chatName");
  const savedRoom  = localStorage.getItem("chatRoom");
  const savedColor = localStorage.getItem("chatColor") || "#000000";

  if (savedName && savedRoom) {
    username = savedName;
    myColor = savedColor;
    colorSelect.value = myColor;

  socket.emit("join", {
  name: username,
  color: myColor,
  room: savedRoom,
  connectKey: localStorage.getItem("connectKey")
});

    // é›»æ°—æ¤…å­UI å³è¡¨ç¤ºï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–ï¼‰
    socket.emit("denkiStateRequest");

    joined = true;

        // ===== åˆå›ç¢ºèªæ¸ˆã¿ãªã‚‰ãƒã‚§ãƒƒã‚¯éè¡¨ç¤º =====
    const confirmed =
      localStorage.getItem(
        "entryConfirmed"
      );

    if (confirmed){
      const loginDiv =
        document.getElementById("login");

      if (loginDiv){
        loginDiv.style.display =
          "none";
      }
    }

    login.style.display = "none";
    chat.style.display = "flex";
  }
});

/* ===== ãƒ­ãƒ“ãƒ¼ã‹ã‚‰ã®æƒ…å ± ===== */
const room = localStorage.getItem("chatRoom");

const descEl =
  document.getElementById("roomDesc");


/* ===== å…¨éƒ¨å±‹å…±é€šï¼šæ–‡å­—è‰² ===== */
descEl.style.color = "black";


/* ===== 1ã€œ4 ãƒ«ãƒ¼ãƒ« ===== */
const isRoom1to4 =
  ["room1","room2","room3","room4"]
    .includes(room);

if (isRoom1to4) {

}


/* ===== é›»æ°—æ¤…å­ ===== */
const isDenki =
  ["denki","denki1","denki2"]
    .includes(room);

if (isDenki) {

  // ===== ä¸‹ã®ç½°UIã‚’éè¡¨ç¤º =====
  const bottomUI =
    document.getElementById("bottomUI");

  if (bottomUI){
    bottomUI.style.display = "none";
  }


  descEl.innerHTML = `
ã€é›»æ°—æ¤…å­ãƒ«ãƒ¼ãƒ«ã€‘<br><br>

2äººå¯¾æˆ¦ãƒ»è¦³æˆ¦å¯èƒ½<br>
ã“ã“ã¯åˆ¶ä½œè€…ãƒŸã‚µã®ã‚ªãƒªã‚¸ãƒŠãƒ«ãƒãƒ£ãƒƒãƒˆã§ã™<br>
ãƒŸã‚µãŒçŸ¥è­˜0ã‹ã‚‰ä½œã‚Š<br>
ãƒŸã‚µãŒã‚µãƒã‚’ãŠé‡‘ã‚’å‡ºã—ã¦å€Ÿã‚Šã¦ã‚‹ã®ã§<br>
ãƒ«ãƒ¼ãƒ«ã‚’å®ˆã‚Œãªã„äººã¯éŠã°ãªã„ã§çµæ§‹ã§ã™ã®ã§å¸°ã£ã¦ãã ã•ã„<br>
éƒ¨å±‹ã«å…¥ã‚Œãªã„æ–¹ã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã‚‹æ–¹ã ã¨æ€ã†ã®ã§é»™ã£ã¦å¸°ã£ã¦ãã ã•ã„<br>

ä»•æ›ã‘ã‚‹å´ã¨åº§ã‚‹å´ã«åˆ†ã‹ã‚Œã¾ã™<br>
ä»•æ›ã‘ã‚‹å´ã¯å¥½ããªæ¤…å­ã«é›»æµã‚’ä»•æ›ã‘ã¾ã™<br>
åº§ã‚‹å´ã¯å¥½ããªæ¤…å­ã«åº§ã‚Šã¾ã™<br><br>

ä»•æ›ã‘ãŸä½ç½®ã¯åˆ¤å®šã¾ã§éå…¬é–‹<br>
åº§ã‚‹ä½ç½®ã¯ç¢ºå®šå¾Œã«è¡¨ç¤ºã•ã‚Œã¾ã™<br>

åˆ¤å®šå¾Œ<br>
é›»æµã ã£ãŸå ´åˆ â†’ 0ç‚¹ï¼‹âš¡1<br>
ã‚»ãƒ¼ãƒ•ã®å ´åˆ â†’ æ¤…å­ç•ªå·ãŒå¾—ç‚¹ã«ãªã‚Šã¾ã™<br>

å‹æ•—æ¡ä»¶<br>
ãƒ»40ç‚¹åˆ°é”<br>
ãƒ»é›»æµ3å›è¢«å¼¾<br>
ãƒ»10ã‚¿ãƒ¼ãƒ³çµ‚äº†<br>
ãƒ»ä½¿ç”¨æ¸ˆã¿æ¤…å­æ®‹ã‚Š1<br>

è² ã‘ãŸå ´åˆSã ã‹ã‚‰ã¨ã„ã£ã¦ç½°ã¯å—ã‘ãªã„ã€å†…ç·’ã§è¡Œã†ãªã©è¨€ã†æ–¹ã¯ã¯ã˜ã‚ã‹ã‚‰ã‚„ã‚ã¦ãã ã•ã„<br>
å‹ã£ãŸã®ã§æº€è¶³ã¨æ­¢ã‚ã‚‹äººã‚‚ã¯ã˜ã‚ã‹ã‚‰ã—ãªã„ã§ãã ã•ã„<br>
æ™‚é–“ã‚„ä½“åŠ›çš„ãªå•é¡Œã§é€”ä¸­ã§æ­¢ã‚ã‚‹ã®ã¯ä»•æ–¹ãªã„ã¨æ€ã„ã¾ã™ãŒã€‚<br>
ä¸Šè¨˜ã®ã‚’ç¢ºèªã—ãŸå ´åˆãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™<br>
ãƒ«ãƒ¼ãƒ«ã‚‚å®ˆã‚Œãªã‹ã£ãŸå ´åˆã‚‚ãƒ–ãƒ­ãƒƒã‚¯ã—ã¾ã™<br>
ç½°å›æ•°ã¯åŸºæœ¬10å›<br>
å‹è€…ã¯ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™å‰ã«1/10ã¨ãã®æ™‚ã®ã‚«ã‚¦ãƒ³ãƒˆã‚’å…¥ã‚Œã‚‹ã“ã¨<br>
å‹è€…ãŒã€Œå¥³å­ç½°ã€ã€Œç”·å­ç½°ã€ã®ã©ã¡ã‚‰ã‹ã®ç½°ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
æ•—è€…ã¯ç½°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„<br>
æ™‚é–“ã‚’è¨ˆã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯æ•—è€…ãŒæ™‚é–“ãƒœã‚¿ãƒ³ä½¿ã£ã¦ãã ã•ã„<br>
ãƒ‘ã‚¹ã®å›æ•°ã¯æ•—è€…ã®å‹åˆ©æ•°<br>
ç½°ãŒçµ‚ã‚ã£ãŸã‚ã¨ã« æ•—è€…ãŒæœ›ã‚ã°ã€çµ¶é ‚ã‚³ãƒãƒ³ãƒ‰ãŒä½¿ãˆã¾ã™<br>
çµ¶é ‚ã‚³ãƒãƒ³ãƒ‰ã¯1åº¦ã®ã¿ãªã®ã§æ³¨æ„ã—ã¦ãã ã•ã„<br>
(ã‚ªãƒŠç³»å¤šã‚ï½¤å†™çœŸå…¬é–‹ã¯ãªã—)<br>
ç½°ã®å¼•ãç›´ã—ã¯ã‚«ã‚¦ãƒ³ãƒˆãŒãšã‚Œã‚‹ã®ã§ã—ãªã„ã“ã¨æ¨å¥¨<br>
ã“ã“ã®ãƒãƒ£ãƒƒãƒˆä»¥å¤–ã®å¤–éƒ¨é€£ã‚Œå‡ºã—ç¦æ­¢<br>
ï¼ˆãƒ«ãƒ–ãƒ«ã®åˆ¥éƒ¨å±‹ã€ãƒ©ãƒ–ãƒ«ã®ãƒ„ãƒ¼ã‚·ãƒ§ã€ãƒ©ã‚¤ãƒ³ã€ã‚«ã‚«ã‚ªãªã©ãªã©ï¼‰<br>
å‘½ä»¤ãŒè¢«ã£ãŸéš›ã¯å‹åˆ©è€…ã«ã‚ˆã‚‹è‡ªç”±å‘½ä»¤ã¨ã™ã‚‹<br>
è‡ªç”±å‘½ä»¤ãŒæ€ã„æµ®ã‹ã°ãªã„å ´åˆã¯ã€Œç”·ã‚ªãƒŠã€ã€Œå¥³ã‚ªãƒŠã€ã§ä»£ã‚ã‚Šã‚‚ã§ãã¾ã™ã€‚<br>
è‡ªç”±å‘½ä»¤ã¨ã‚ã‚Šã¾ã™ãŒã€å€‹äººæƒ…å ±ã€å†™çœŸã®è¦æ±‚ã‚„NGè¡Œç‚ºã®å¼·è¦ã¯ã—ãªã„<br>
è‡ªåˆ†ã®å†™çœŸã‚’æ™’ã™è¡Œç‚ºãªã©ã‚‚ç¦æ­¢ã—ã¾ã™<br>
ç½°ã§ã¯ã‚ã‚Šã¾ã™ãŒæ•—è€…ã‚‚é æ…®ãªããŠæ–­ã‚Šã—ã¦ãã ã•ã„<br>
å†…ç·’æ©Ÿèƒ½è¿½åŠ ã—ã¾ã—ãŸãŒã€é‚ªé­”ã«ãªã‚‰ãªã„ã‚ˆã†ã«æ•—è€…ã«ã¯ã—ãªã„ã§ãã ã•ã„<br>
å‹åˆ©è€…ãŒã„ãªã„å ´åˆã¯15åˆ†å¾…ã£ã¦çµ‚äº†<br>
è¦‹å­¦è€…ã«å‘½ä»¤å‡ºã™æ¨©åˆ©ã¯ã‚ã‚Šã¾ã›ã‚“ã€ç…½ã‚‹ç¨‹åº¦ã«ã—ã¦ãã ã•ã„<br>
ã²ã©ã„äººã¯ãƒŸãƒ¥ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚<br>
ä¸‹ã®éƒ¨å±‹ã¾ã§å•é¡Œã‚ã‚‹äººã¯å ±å‘Šãã‚Œã‚Œã°ãƒ–ãƒ­ãƒƒã‚¯å¯¾è±¡ã‹è€ƒãˆã¾ã™<br>

<br><br>
ä½•ã‹ã‚ã£ãŸéš›ã¯â†“<br>
<a href="https://chat.luvul.net/ChatRoom?room_id=428529" target="_blank">
https://chat.luvul.net/ChatRoom?room_id=428529
</a>
`;
}


const roomNames = {
  room1: "ãƒ«ãƒ¼ãƒ 1",
  room2: "ãƒ«ãƒ¼ãƒ 2",
  room3: "ãƒ«ãƒ¼ãƒ 3",
  room4: "ãƒ«ãƒ¼ãƒ 4",
  room5: "å¥³å­éƒ¨å±‹",
  room6: "å·»ãè¾¼ã¿",   // â† è¿½åŠ 
  denki: "é›»æ°—1",
  denki1: "é›»æ°—æ¤…2",
  denki2: "é›»æ°—3",
  special: "ã‚¹ãƒšã‚·ãƒ£ãƒ«",
  privateA: "å€‹å®¤A",
  privateB: "å€‹å®¤B",
  privateC: "å€‹å®¤C",
  privateD: "å€‹å®¤D"
};


const roomLabel = document.getElementById("roomLabel");

if (roomLabel && room) {
  roomLabel.textContent = `${roomNames[room] || room}`;
}


// ===== è‹¦ç—›ç½°è¡¨ç¤ºåˆ¶å¾¡ =====

const painPunishBtn =
  document.getElementById("denkiPainPunishBtn");

if (painPunishBtn){

  if (
    room === "denki"  ||
    room === "denki1" ||
    room === "denki2"
  ){
    painPunishBtn.style.display =
      "inline-block";
  }
  else{
    painPunishBtn.style.display =
      "none";
  }

}




const key = localStorage.getItem("chatKey");


if (!room && !joined) {
  alert("ãƒ­ãƒ“ãƒ¼ã‹ã‚‰å…¥å®¤ã—ã¦ãã ã•ã„");
  
if (
  room === "denki" ||
  room === "denki1" ||
  room === "denki2"
){
  location.href = "/denki.html";
} else {
  location.href = "/index.html";
}

}
if (room) roomInfo.textContent = `å…¥å®¤å…ˆï¼š${room}`;

/* ===== è¡¨ç¤º ===== */
function renderMsg(d) {
  const li = document.createElement("li");

  if (d.time) {
    const t = document.createElement("span");
    t.textContent = `[${d.time}] `;
    t.className = "time";
    li.appendChild(t);
  }

  const text = document.createElement("span");
  if (d.private) {
    const toName = d.toName || "ç›¸æ‰‹";
    text.textContent = `ã€å†…ç·’ã€‘${d.name} â–¶ ${toName}: ${d.text}`;
    li.classList.add("private");
  } else {
    text.textContent = `${d.name}: ${d.text}`;
  }

 li.appendChild(text);
li.style.color = d.color || "#000";

if (d.bold) {
  text.style.fontWeight = "bold";
}

messages.prepend(li);

}

/* ===== å—ä¿¡ ===== */
socket.on("connect", () => {

  myId = socket.id;

  // é›»æ°—æ¤…å­ çŠ¶æ…‹å–å¾—
  socket.emit("denkiStateRequest");

});

socket.on("pastMessages", logs => {

  messages.innerHTML = "";
  logs.forEach(renderMsg);

 // ===== çµ¶é ‚è§£æ”¾ãƒ­ã‚°åˆ¤å®š =====
const unlocked = logs.some(m =>
  m.text?.includes("çµ¶é ‚è¨±å¯ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸ")
);

if (unlocked){
  const btn = document.getElementById("denkiZecchoBtn");
  if (btn) btn.style.display = "inline-block";
}

});

// ===== å€‹äººãƒŸãƒ¥ãƒ¼ãƒˆç®¡ç† =====
let myMutes = [];

// server ã‹ã‚‰åŒæœŸï¼ˆå¾Œã§æ‹¡å¼µç”¨ï¼‰
socket.on("muteSync", list => {
  myMutes = list || [];
});

socket.on("message", d => {


// ===== ãƒŸãƒ¥ãƒ¼ãƒˆé®æ–­ =====
if (d.name && myMutes.includes(d.name)) {
  return;
}


  // ===== å†…ç·’è¡¨ç¤ºåˆ¶å¾¡ =====
  if (d.private) {
    if (d.to !== myId && d.name !== username) return;
  }

  // ===== é€šçŸ¥éŸ³ =====
  if (
    soundLevel !== "off" &&
    d.name &&
    d.name !== username
  ) {
    notifySound.volume =
      SOUND_LEVELS[soundLevel];

    notifySound.currentTime = 0;
    notifySound.play().catch(()=>{});
  }

  renderMsg(d);

});

socket.on("zecchoUnlock", () => {

  const btn = document.getElementById("denkiZecchoBtn");

  if (btn){
    btn.style.display = "inline-block";
  }

});

// ===== ã‚¿ã‚¤ãƒãƒ¼åŒæœŸ =====
let timerInterval = null;

socket.on("timerSync", ({ endTime }) => {

  const display =
    document.getElementById("timerDisplay");

  if (!display) return;

  display.style.display = "block";

  if (timerInterval){
    clearInterval(timerInterval);
  }

  timerInterval = setInterval(() => {

    const remain =
      Math.max(0, endTime - Date.now());

    const sec =
      Math.floor(remain / 1000);

    const m =
      String(Math.floor(sec / 60))
        .padStart(2,"0");

    const s =
      String(sec % 60)
        .padStart(2,"0");

    display.textContent =
      `â± ${m}:${s}`;

    if (remain <= 0){
      clearInterval(timerInterval);
    }

  }, 1000);

});

// ===== ã‚¿ã‚¤ãƒãƒ¼çµ‚äº† =====
socket.on("timerEnd", () => {

  const display =
    document.getElementById("timerDisplay");

  if (display){
    display.style.display = "none";
  }

  if (timerInterval){
    clearInterval(timerInterval);
  }

});

socket.on("orgasmUsed", () => {
  const btn = document.getElementById("denkiZecchoBtn");
  if (btn) btn.style.display = "none";
});

socket.on("zecchoHide", () => {
  const btn = document.getElementById("denkiZecchoBtn");
  if (btn) btn.style.display = "none";
});


socket.on("userList", list => {

  userList.innerHTML = "";
  privateTarget.innerHTML =
    `<option value="">ãªã—</option>`;

  list.forEach(u => {

    const li = document.createElement("li");

const nameSpan = document.createElement("span");

nameSpan.textContent =
  (u.isAdmin ? "ğŸ‘‘" : "") + u.name;

nameSpan.style.color =
  u.color || "#000";

li.appendChild(nameSpan);

    
    // ===== è‡ªåˆ†ä»¥å¤–ã®ã¿æ“ä½œãƒœã‚¿ãƒ³ =====
    if (u.id !== myId) {

      // å†…ç·’ç”¨
      const opt =
        document.createElement("option");

      opt.value = u.id;
      opt.textContent = u.name;

      privateTarget.appendChild(opt);

    
   // ===== ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³ =====
const muteBtn =
  document.createElement("button");

// åˆæœŸè¡¨ç¤º
if (myMutes.includes(u.name)) {
  muteBtn.textContent = "æ¸ˆ";
} else {
  muteBtn.textContent = "æ¶ˆ";
}

muteBtn.style.marginLeft = "6px";
muteBtn.style.padding = "2px 6px";
muteBtn.style.fontSize = "12px";
muteBtn.style.lineHeight = "1.2";

muteBtn.onclick = () => {

  socket.emit("muteUser", u.id);

  // è¡¨ç¤ºãƒˆã‚°ãƒ«
  if (muteBtn.textContent === "æ¶ˆ") {
    muteBtn.textContent = "æ¸ˆ";
  } else {
    muteBtn.textContent = "æ¶ˆ";
  }

};


      li.appendChild(muteBtn);
    }

    userList.appendChild(li);

  });

});


/* ===== é›»æ°—æ¤…å­ï¼šçŠ¶æ…‹ ===== */
socket.on("denkiState", state => {
  denkiState = state;

  if (!denkiState || !denkiState.players) return;

  updateDenkiUI();
});

function onDenkiSelect(seat) {
  if (!denkiState || !denkiState.players) return;
  if (!denkiState.started) return;   // â† è¿½åŠ 

  const players = denkiState.players || [];

  let me = players.find(p => p.id === myId);

  // â˜… IDã‚ºãƒ¬ä¿é™º
  if (!me) {
    me = players.find(p => p.name === username);
  }

  if (!me) return;


// ===== ã‚¿ãƒ¼ãƒ³æœ¬äººåˆ¤å®š =====
const turnPlayer =
  denkiState.players[denkiState.turn];

const isMyTurn =
  turnPlayer?.id === myId ||
  turnPlayer?.name === username;


// ä»•æ›ã‘ã‚‹å´
if (
  denkiState.phase === "set" &&
  isMyTurn
) {

  selectedSeat = seat;

  // â˜… ä»®é¸æŠå³æç”»
  updateDenkiUI();

  return;
}




// ===== åº§ã‚Šä»®é¸æŠ =====
if (
  denkiState.phase === "sit"
) {

  selectedSeat = seat;

  socket.emit(
    "denkiSit",
    seat
  );

  const sitBtn =
    document.getElementById("denkiSitBtn");

  if (sitBtn){
    sitBtn.disabled = false;
  }

}




}
function updateDenkiUI() {

  denkiWrap.style.display = "block";

  if (
  !denkiState ||
  !denkiState.players
) return;


  const players = denkiState.players;
  const me = players.find(p => p.id === myId); // è¦³å®¢ã¯ undefined


  // ===== ãƒœã‚¿ãƒ³åˆæœŸçŠ¶æ…‹ =====
  denkiSetBtn.style.display = "inline-block";
  denkiSitBtn.style.display = "inline-block";
  denkiShockBtn.style.display = "inline-block";

  denkiSetBtn.disabled = true;
  denkiSitBtn.disabled = true;
  denkiShockBtn.disabled = true;
  denkiConfirmBtn.disabled = true;
  


  // ===== è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š =====
  const isSpectator = !me;
  // ===== è¦³æˆ¦UIèª¿æ•´ =====
if (isSpectator) {

  denkiSetBtn.style.display = "none";
  denkiSitBtn.style.display = "none";
  denkiShockBtn.style.display = "none";

  denkiStatus.textContent = "ğŸ‘€ è¦³æˆ¦ä¸­";
}

 

 // ===== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œåˆ¶å¾¡ =====
if (!isSpectator) {

  // ===== ã‚¿ãƒ¼ãƒ³æœ¬äººåˆ¤å®š =====
  const turnPlayer =
    players[denkiState.turn];

  const isMyTurn =
    turnPlayer?.id === myId ||
    turnPlayer?.name === username;


  if (
    denkiState.phase === "set" &&
    isMyTurn
  ) {
    denkiSetBtn.disabled = false;
    denkiStatus.textContent =
      "ã‚ãªãŸã®ç•ªï¼šæ¤…å­ã‚’ä»•æ›ã‘ã‚‹";
  }

 else if (
  denkiState.started &&
  denkiState.phase === "sit" &&
  !isMyTurn
) {
  denkiSitBtn.disabled = false;
  denkiStatus.textContent =
    "ã‚ãªãŸã®ç•ªï¼šæ¤…å­ã«åº§ã‚‹";
}


  else if (
    denkiState.phase === "shock" &&
    isMyTurn
  ) {
    denkiShockBtn.disabled = false;
    denkiStatus.textContent =
      "âš¡ é›»æµã‚’æµã—ã¦ãã ã•ã„";
  }

  else {
    denkiStatus.textContent =
      "ç›¸æ‰‹ã®æ“ä½œå¾…ã¡";
  }

}


  // ===== ã‚¹ã‚³ã‚¢è¡¨ç¤º =====
  denkiScore.textContent = players.map(p =>
    `${p.name}: ${p.score}ç‚¹ / âš¡${p.shock}`
  ).join(" ï½œ ");


  // ===== ç‚¹æ•°è¡¨ =====
  const rowA = document.getElementById("denkiRowA");
  const rowB = document.getElementById("denkiRowB");

  const pA = players[0];
  const pB = players[1];

  if (pA && rowA) {
    rowA.children[0].textContent = pA.name;

    let totalA = 0;

    for (let i = 1; i <= 9; i++) {

      const v = pA.turns?.[i - 1];

      if (v === "shock") {
        rowA.children[i].textContent = "âš¡";
        totalA = 0;
      }
      else if (typeof v === "number") {
        rowA.children[i].textContent = v;
        totalA += v;
      }
      else {
        rowA.children[i].textContent = "-";
      }
    }

    rowA.children[10].textContent = totalA;

  }

  if (pB && rowB) {
    rowB.children[0].textContent = pB.name;

    let totalB = 0;

    for (let i = 1; i <= 10; i++) {
      const v = pB.turns?.[i - 1];

      if (v === "shock") {
        rowB.children[i].textContent = "âš¡";
        totalB = 0;
      }
      else if (typeof v === "number") {
        rowB.children[i].textContent = v;
        totalB += v;
      }
      else {
        rowB.children[i].textContent = "-";
      }
    }

    rowB.children[10].textContent = totalB;

  }


  // ===== æ¤…å­æç”» =====
const buttons = denkiBoard.querySelectorAll("button");
buttons.forEach(b => {

  const num = Number(b.textContent);

  b.style.background = "";
  b.disabled = true;
  b.style.display = "inline-block";

// ===== è‡ªåˆ†ä»®é¸æŠè‰² =====
if (selectedSeat === num) {
  b.style.background = "red";
}



 // ä½¿ç”¨æ¸ˆã¿éè¡¨ç¤º
if (
  denkiState.usedSeats?.includes(num)
) {
  b.style.display = "none";
  return;
}


// ===== ã‚¿ãƒ¼ãƒ³æœ¬äººåˆ¤å®š =====
const turnPlayer =
  players[denkiState.turn];

const isMyTurn =
  turnPlayer?.id === myId ||
  turnPlayer?.name === username;


// ä»•æ›ã‘ãƒ•ã‚§ãƒ¼ã‚º
if (
  denkiState.phase === "set" &&
  isMyTurn
) {
  b.disabled = false;

  // ===== è‡ªåˆ†ã ã‘ä»•æ›ã‘è‰² =====
  if (selectedSeat === num) {
    b.style.background = "red";
  }
}


// åº§ã‚Šãƒ•ã‚§ãƒ¼ã‚º
if (
  denkiState.phase === "sit" &&
  !isMyTurn &&
  !isSpectator
) {
  b.disabled = false;
}



  // ä»®åº§ã‚Šè¡¨ç¤ºï¼ˆå…¨å“¡ï¼‰
  if (denkiState.sitPreview === num) {
    b.style.background = "#ccccff";
  }

  // ç¢ºå®šåº§ã‚Šè¡¨ç¤º
  if (denkiState.phase === "shock" && denkiState.sitSeat === num) {
    b.style.background = "#ccccff";
  }

});

// ===== å‚åŠ ãƒœã‚¿ãƒ³åˆ¶å¾¡ =====
const meJoined =
  denkiState.players.some(p => p.id === myId);

// ===== è©¦åˆä¸­åˆ¤å®š =====
const gamePlaying =
  denkiState.started === true &&
  !denkiState.ended;


// ===== è¡¨ç¤ºåˆ¶å¾¡ =====
if (meJoined || gamePlaying) {
  denkiJoinBtn.style.display = "none";
}
else {
  denkiJoinBtn.style.display = "inline-block";
}


}





// ===== æ¥ç¶šã‚­ãƒ¼ç”Ÿæˆ =====
let connectKey =
  localStorage.getItem("connectKey");

if (!connectKey){

  connectKey =
    Math.random().toString(36).slice(2) +
    Date.now().toString(36);

  localStorage.setItem(
    "connectKey",
    connectKey
  );

}

/* ===== å…¥å®¤å‡¦ç† ===== */
joinBtn.onclick = () => {
  if (joined || !nameInput.value.trim()) return;

    // ===== ç¢ºèªãƒã‚§ãƒƒã‚¯åˆ¤å®š =====
  const ageCheck =
    document.getElementById("confirmAge");

  const ruleCheck =
    document.getElementById("confirmRule");

  const ipCheck =
    document.getElementById("confirmIp");

  const confirmed =
    localStorage.getItem(
      "entryConfirmed"
    );

  // åˆå›ã®ã¿å¿…é ˆ
  if (!confirmed) {

    if (
      !ageCheck?.checked ||
      !ruleCheck?.checked ||
      !ipCheck?.checked
    ){
      alert(
        "ç¢ºèªé …ç›®ã‚’ã™ã¹ã¦ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„"
      );
      return;
    }

    localStorage.setItem(
      "entryConfirmed",
      "true"
    );
  }


  username = nameInput.value.trim();
  localStorage.setItem("chatName", username);

  socket.emit("join", {
  name: username,
  color: myColor,
  room,
  key,
  connectKey
});


  // é›»æ°—æ¤…å­UI å³è¡¨ç¤º
  socket.emit("denkiStateRequest");

  joined = true;
  login.style.display = "none";
  chat.style.display = "flex";
};

/* ===== æ“ä½œ ===== */
colorSelect.oninput = () => {
  myColor = colorSelect.value;
  localStorage.setItem("chatColor", myColor);
  socket.emit("updateColor", { color: myColor });
};

soundSelect.onchange = () => {
  soundLevel = soundSelect.value;
  localStorage.setItem("soundLevel", soundLevel);
};

privateTarget.onchange = () => {
  privateTo = privateTarget.value || "";
};

sendBtn.onclick = () => {
  if (!input.value.trim()) return;
  socket.emit("message", {
    text: input.value.trim(),
    color: myColor,
    to: privateTo || undefined
  });
  input.value = "";
  privateTo = "";
  privateTarget.value = "";
};

input.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});

leaveBtn.onclick = () => {
  socket.emit("leave");
  localStorage.removeItem("chatName");
  localStorage.removeItem("chatRoom");
  localStorage.removeItem("chatKey");
  location.href = "/lobby.html";
};
function sendPunish(cmd){
  socket.emit("message",{ text: cmd });
}
function sendDice(cmd){
  socket.emit("message",{ text: cmd });
}
document.getElementById("ruleBtn").onclick = () => {
  const w = window.open("", "_blank");

  w.document.write("<pre>" +
    document.getElementById("roomDesc").innerText +
    "</pre>");
};

window.addEventListener("load", () => {

 // ===== ç½°ãƒˆã‚°ãƒ«ï¼ˆé€šå¸¸ï¼‰ =====
const normalToggle =
  document.getElementById("punishToggleBtn");

const normalWrap =
  document.getElementById("punishWrap");

if (normalToggle && normalWrap){

  let open = false;

  normalToggle.onclick = () => {
    open = !open;
    normalWrap.style.display =
      open ? "flex" : "none";
  };

}


// ===== ç½°ãƒˆã‚°ãƒ«ï¼ˆé›»æ°—æ¤…å­ï¼‰ =====
const denkiToggle =
  document.getElementById("denkiPunishToggleBtn");

const denkiWrap2 =
  document.getElementById("denkiPunishWrap");

if (denkiToggle && denkiWrap2){

  let open2 = false;

  denkiToggle.onclick = () => {
    open2 = !open2;
    denkiWrap2.style.display =
      open2 ? "flex" : "none";
  };

}


  
  // ===== ã‚¿ã‚¤ãƒãƒ¼ãƒœã‚¿ãƒ³ï¼ˆé€šå¸¸ã¨é›»æ°—åˆ†é›¢ï¼‰ =====

// é€šå¸¸
const normalTimer3Btn =
  document.getElementById("timer3Btn");

const normalTimer5Btn =
  document.getElementById("timer5Btn");

if (normalTimer3Btn){
  normalTimer3Btn.onclick = () => {
    socket.emit("timerStart", { seconds: 180 });
  };
}

if (normalTimer5Btn){
  normalTimer5Btn.onclick = () => {
    socket.emit("timerStart", { seconds: 300 });
  };
}

// é›»æ°—æ¤…å­
const denkiTimer3Btn =
  document.getElementById("denkiTimer3Btn");

const denkiTimer5Btn =
  document.getElementById("denkiTimer5Btn");

if (denkiTimer3Btn){
  denkiTimer3Btn.onclick = () => {
    socket.emit("timerStart", { seconds: 180 });
  };
}

if (denkiTimer5Btn){
  denkiTimer5Btn.onclick = () => {
    socket.emit("timerStart", { seconds: 300 });
  };
}

// ===== ä»»æ„ã‚¿ã‚¤ãƒãƒ¼ï¼ˆé€šå¸¸ï¼‰ =====
const normalTimerCustomBtn =
  document.getElementById("timerCustomBtn");

const normalTimerCustomInput =
  document.getElementById("timerCustomInput");

if (normalTimerCustomBtn){

  normalTimerCustomBtn.onclick = () => {

    const min =
      parseInt(normalTimerCustomInput.value);

    if (!min || min <= 0) return;

    socket.emit("timerStart", {
      seconds: min * 60
    });

    normalTimerCustomInput.value = "";

  };

}

// ===== ä»»æ„ã‚¿ã‚¤ãƒãƒ¼ï¼ˆé›»æ°—æ¤…å­ï¼‰ =====
const denkiTimerCustomBtn =
  document.getElementById("denkiTimerCustomBtn");

const denkiTimerCustomInput =
  document.getElementById("denkiTimerCustomInput");

if (denkiTimerCustomBtn){

  denkiTimerCustomBtn.onclick = () => {

    const min =
      parseInt(denkiTimerCustomInput.value);

    if (!min || min <= 0) return;

    socket.emit("timerStart", {
      seconds: min * 60
    });

    denkiTimerCustomInput.value = "";

  };

}


});



</script>

</body>
</html>
