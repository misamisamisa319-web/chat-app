<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>掲示板</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family: sans-serif;
  padding: 10px;
}

.thread {
  border:1px solid #ccc;
  padding:10px;
  margin-bottom:10px;
  cursor:pointer;
}

.post {
  border-bottom:1px solid #eee;
  padding:4px 0;
}

#threadView {
  display:none;
}
</style>
</head>
<body>

<h2>掲示板</h2>

<div>
  <input id="newTitle" placeholder="スレタイトル">
  <button onclick="createThread()">作成</button>
</div>

<hr>

<div id="threadList"></div>

<div id="threadView">
  <button onclick="back()">←戻る</button>
  <h3 id="threadTitle"></h3>

  <div id="posts"></div>

  <input id="name" placeholder="名前">
  <input id="text" placeholder="内容">
  <button onclick="post()">投稿</button>
</div>

<script>
let currentThread = null;

fetch("/bbs")
  .then(r => r.json())
  .then(data => {

    const list = document.getElementById("threadList");
    list.innerHTML = "";

    data.threads.forEach(t => {

  const div = document.createElement("div");
  div.className = "thread";

  const title = document.createElement("span");
  title.textContent = t.title;
  title.onclick = ()=>openThread(t.id);

  div.appendChild(title);

  // ★ 管理人だけ削除ボタン
  if (localStorage.getItem("isAdmin") === "true") {

    const delBtn = document.createElement("button");
    delBtn.textContent = "削除";
    delBtn.onclick = (e)=>{
      e.stopPropagation();
      deleteThread(t.id);
    };

    div.appendChild(delBtn);
  }

  list.appendChild(div);

});

});

function loadThreads(){

  fetch("/bbs")
    .then(r => r.json())
    .then(data => {

      const list = document.getElementById("threadList");
      list.innerHTML = "";

      data.threads.forEach(t => {

        const div = document.createElement("div");
        div.className = "thread";
        div.textContent = t.title;
        div.onclick = ()=>openThread(t.id);

        list.appendChild(div);

      });

    });

}

function openThread(id){

  currentThread = id;

  fetch("/bbs")
    .then(r=>r.json())
    .then(data=>{

     const t = data.threads.find(x => x.id === id);
      if (!t) return;

      document.getElementById("threadList").style.display="none";
      document.getElementById("threadView").style.display="block";
      document.getElementById("threadTitle").textContent = t.title;

     // ↓これ追加
    const delBtn = document.createElement("button");
    delBtn.textContent = "スレ削除";
    delBtn.onclick = () => deleteThread(t.id);
    posts.appendChild(delBtn);

    const posts = document.getElementById("posts");
    posts.innerHTML = "";

    

      t.posts.forEach(p=>{
        const div = document.createElement("div");
        div.className="post";
        div.textContent = `[${p.time}] ${p.name}: ${p.text}`;

if (localStorage.getItem("isAdmin") === "true"){

  const delBtn = document.createElement("button");
  delBtn.textContent = "削除";

  delBtn.onclick = ()=>{
    fetch("/bbs/deletePost",{
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded" },
      body:`threadId=${currentThread}&time=${p.time}`
    }).then(()=>{
      openThread(currentThread);
    });
  };

  div.appendChild(delBtn);
}

        posts.appendChild(div);
      });

    });

}

function back(){
  document.getElementById("threadList").style.display="block";
  document.getElementById("threadView").style.display="none";
}

function post(){

  const name = document.getElementById("name").value;
  const text = document.getElementById("text").value;

  fetch("/bbs/post",{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body:`threadId=${currentThread}&name=${name}&text=${text}`
  }).then(()=>{
    openThread(currentThread);
    document.getElementById("text").value="";
  });

}

function createThread(){

  const title = document.getElementById("newTitle").value;

  fetch("/bbs/create",{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body:`title=${title}`
  }).then(()=>{
    loadThreads();
    document.getElementById("newTitle").value="";
  });

}
function deleteThread(id){

  fetch("/bbs/delete",{
    method:"POST",
    headers:{ "Content-Type":"application/x-www-form-urlencoded" },
    body:`threadId=${id}&key=12345678`
  }).then(()=>{
    loadThreads();
  });

}


loadThreads();

</script>

</body>
</html>