<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Chat v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  font-family:
    -apple-system,
    BlinkMacSystemFont,
    "Segoe UI",
    "Hiragino Kaku Gothic ProN",
    "Hiragino Sans",
    "Noto Sans JP",
    Meiryo,
    sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

#login, #chat { flex: 1; display: flex; flex-direction: column; }
#chat { display: none; }

.system { color: gray; }
.system.girl { color: red; font-weight: bold; }
.system.boy { color: blue; font-weight: bold; }

#controls { display: flex; gap: 5px; padding: 5px; position: sticky; top: 0; background: #fff; z-index: 10; }
input, button, select { padding: 10px; font-size: 16px; }
#punishWrap {
  gap: 20px;   /* ボタン同士の間隔 */

  position: absolute;
  bottom: 100%;
  left: 0;
  right: 0;

  background: #fff;
  padding: 8px;
  z-index: 200;
}
#punishWrap button {
  padding: 6px 12px;  /* ボタンの中の余白 */
  font-size: 16px;   /* 文字サイズ */
}


#userList {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  background: #f0f0f0;
  padding: 5px;
  list-style: none;
  align-items: center;
}

#userList li {
  padding: 3px 8px;
  border-radius: 5px;
  white-space: nowrap;
}


#settings { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; padding: 5px; background: #f9f9f9; border-bottom: 1px solid #ccc; }
#settings input, #settings button, #settings select { padding: 5px; font-size: 14px; }

#messages {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow-y: auto;
  padding: 10px;
  list-style: none;
  padding-bottom: 260px;
}
#messages li { margin-bottom: 5px; }
.private { background: #fff3cd; padding: 3px 6px; border-radius: 4px; }

.time { opacity: .6; margin-right: 4px; }

/* ===== 電気椅子UI ===== */
#denkiWrap {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;

  margin: 0;
  padding: 10px;
  background: #e8f5fb;
  border-radius: 8px 8px 0 0;

  display: none;
  z-index: 50;
}


#denkiHeader {
  font-weight: bold;
  margin-bottom: 6px;
}
#denkiStatus {
  margin-bottom: 6px;
}
#denkiBoard {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 8px;
}
#denkiBoard button {
  width: 44px;
  
}
#denkiScore {
  font-size: 14px;
  margin-bottom: 6px;
}
#bottomUI {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;

  background: #fff;
  border-top: 1px solid #ccc;

  padding: 8px;
  z-index: 100;
}

</style>
</head>
<body>

<div id="login">
  <h2>入室</h2>

  <div id="roomInfo"
       style="margin-bottom:10px; color:#555;">
  </div>

  <!-- ===== ルール説明 ===== -->
<div style="
  margin-top:14px;
  padding:10px;
  font-size:13px;
  line-height:1.6;
  background:#f5f5f5;
  border:1px solid #ccc;
">

<strong>利用ルール</strong><br><br>

<div id="roomDesc"
     style="
       margin-bottom:12px;
       white-space:pre-wrap;
       font-size:13px;
       line-height:1.6;
     ">
</div>

</div>


  <input id="nameInput"
         placeholder="名前">

  <!-- ===== 確認チェック ===== -->
  <div style="
    margin-top:12px;
    font-size:14px;
    line-height:1.6;
  ">

    <label>
      <input type="checkbox"
             id="confirmAge">
      18歳未満の利用は禁止です
    </label>
    <br>

    <label>
      <input type="checkbox"
             id="confirmRule">
      ルール・禁止事項を確認しました
    </label>
    <br>

    <label>
      <input type="checkbox"
             id="confirmIp">
      IPアドレスは保管され、
      問題発生時は開示される可能性があります
    </label>


  </div>

  <button id="joinBtn"
          style="margin-top:12px;">
    入室
  </button>
</div>

<div id="chat">
 <div id="controls">
  <input id="input" placeholder="メッセージ">
  <button id="sendBtn">送信</button>

  <span id="roomLabel"
    style="padding:10px; font-weight:bold;">
  </span>
</div>


  <!-- ⚡ 電気椅子（denki ルームのみ表示） -->
  <div id="denkiWrap">
   
  <!-- ===== 罰＋タイマー（電気椅子用） ===== -->
<div id="denkiPunishArea" style="margin-bottom:10px;">

  <!-- トグル＋タイマー -->
  <div style="display:flex; gap:8px; flex-wrap:wrap;">
    <button id="denkiPunishToggleBtn">罰メニュー</button>

    <button id="denkiTimer3Btn">3分</button>
    <button id="denkiTimer5Btn">5分</button>

    <input id="denkiTimerCustomInput"
      type="number"
      min="1"
      step="1"
      placeholder="分"
      style="width:60px;">

    <button id="denkiTimerCustomBtn">任意</button>
  </div>

  <!-- 罰ボタン -->
  <div id="denkiPunishWrap" style="
  display:none;
  gap:7px;
  flex-wrap:wrap;
  padding:6px 0;
">

    <button onclick="sendPunish('女子罰')">女子罰</button>

    <button id="denkiBoyPunishBtn"
      onclick="sendPunish('男子罰')">
      男子罰
    </button>

    <button onclick="sendPunish('命令女')">女オナ</button>

    <button id="denkiBoyOnaBtn"
      onclick="sendPunish('命令男')">
      男オナ
    </button>

    <button id="denkiPainPunishBtn"
      onclick="sendPunish('苦痛罰')">
      苦痛罰
    </button>

    <button id="denkiZecchoBtn"
      onclick="sendPunish('絶頂許可')"
      style="display:none;">
      絶頂許可
    </button>

</div>

</div>  
    <!-- ===== 電気椅子 点数表 ===== -->
<table id="denkiTable" style="
  width:100%;
  border-collapse:collapse;
  margin-bottom:10px;
  font-size:14px;
">
  <thead>
    <tr>
      <th style="border:1px solid #999;">名前</th>
      <th style="border:1px solid #999;">1</th>
      <th style="border:1px solid #999;">2</th>
      <th style="border:1px solid #999;">3</th>
      <th style="border:1px solid #999;">4</th>
      <th style="border:1px solid #999;">5</th>
      <th style="border:1px solid #999;">6</th>
      <th style="border:1px solid #999;">7</th>
      <th style="border:1px solid #999;">8</th>
      <th style="border:1px solid #999;">9</th>
      <th style="border:1px solid #999;">合計</th>
    </tr>
  </thead>
  <tbody>
    <tr id="denkiRowA">
      <td style="border:1px solid #999;">A</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">0</td>
    </tr>
    <tr id="denkiRowB">
      <td style="border:1px solid #999;">B</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">0</td>
    </tr>
  </tbody>
</table>

    <div id="denkiStatus">待機中</div>
    <div id="denkiScore"></div>
    <div id="denkiBoard"></div>
    <button id="denkiJoinBtn">参加</button>
<button id="denkiSetBtn">仕掛ける</button>
<button id="denkiShockBtn">⚡ 電流流す</button>
<button id="denkiSitBtn">座る</button>
<button id="denkiConfirmBtn">決定</button>





  </div>
<!-- ===== 参加者 ===== -->
<div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
  <strong>参加者:</strong>
  <ul id="userList"></ul>
</div>



<div id="bottomUI">

<!-- ===== タイマー＋罰トグル横並び ===== -->
<div id="timerPunishRow" style="
  display:flex;
  gap:8px;
  padding:4px 0;
  flex-wrap:wrap;
">

  <!-- 罰トグル -->
  <button id="punishToggleBtn">
    罰メニュー
  </button>

  <!-- タイマー -->
  <button id="timer3Btn">3分</button>
  <button id="timer5Btn">5分</button>
  <input id="timerCustomInput"
  type="number"
  min="1"
  step="1"
  placeholder="分"
  style="width:60px;">

<button id="timerCustomBtn">
  任意
</button>


</div>

<!-- ===== 罰ボタン本体 ===== -->
<div id="punishWrap" style="
  display:none;
  gap:7px;
  flex-wrap:wrap;
  padding:6px 0;
">

  <button onclick="sendPunish('女子罰')">女子罰</button>

  <button id="boyPunishBtn"
    onclick="sendPunish('男子罰')">
    男子罰
  </button>

  <button onclick="sendPunish('命令女')">女オナ</button>

  <button id="boyOnaBtn"
    onclick="sendPunish('命令男')">
    男オナ
  </button>

  <button id="painPunishBtn"
    onclick="sendPunish('苦痛罰')">
    苦痛罰
  </button>

  <button id="zecchoBtn"
    onclick="sendPunish('絶頂許可')"
    style="display:none;">
    絶頂許可
  </button>

  <button id="maleEventBtn"
    style="display:none;"
    onclick="sendPunish('男イベント')">
    男イベント
  </button>

  <button id="femaleEventBtn"
    style="display:none;"
    onclick="sendPunish('女イベント')">
    女イベント
  </button>

  <button id="commonEventBtn"
    style="display:none;"
    onclick="sendPunish('共通イベント')">
    共通イベント
  </button>

</div>

<!-- ===== ダイスボタンRow ===== -->
<div id="diceRow" style="
  display:flex;
  gap:8px;
  padding:4px 0;
  flex-wrap:wrap;
">

  <button onclick="sendDice('2d6')">S</button>
  <button onclick="sendDice('2d5')">N</button>
  <button onclick="sendDice('2d4')">M</button>

</div>

</div>

<div id="timerDisplay"
     style="
       font-weight:bold;
       padding:4px 0;
       display:none;">
  ⏱ 00:00
</div>

<div id="settings">

    <label>色: <input type="color" id="colorSelect" value="#000000"></label>
    <label>内緒:
      <select id="privateTarget">
        <option value="">なし</option>
      </select>
    </label>
    <label>
      音:
      <select id="soundSelect">
        <option value="off">OFF</option>
        <option value="small">小</option>
        <option value="medium">中</option>
        <option value="large">大</option>
      </select>
    </label>
    <button id="leaveBtn">退出</button>
  </div>

  <ul id="messages"></ul>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

const login = document.getElementById("login");
const chat = document.getElementById("chat");
const joinBtn = document.getElementById("joinBtn");
const nameInput = document.getElementById("nameInput");
const roomInfo = document.getElementById("roomInfo");

const messages = document.getElementById("messages");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const leaveBtn = document.getElementById("leaveBtn");
const userList = document.getElementById("userList");
const colorSelect = document.getElementById("colorSelect");
const privateTarget = document.getElementById("privateTarget");
const soundSelect = document.getElementById("soundSelect");

const notifySound = new Audio("/notify.mp3");
const SOUND_LEVELS = { off:0, small:0.2, medium:0.5, large:1.0 };
let soundLevel = localStorage.getItem("soundLevel") || "off";
soundSelect.value = soundLevel;

let username = "";
let myColor = "#000000";
let privateTo = "";
let joined = false;

/* ===== 電気椅子DOM ===== */
const denkiWrap = document.getElementById("denkiWrap");
const denkiStatus = document.getElementById("denkiStatus");
const denkiBoard = document.getElementById("denkiBoard");
const denkiScore = document.getElementById("denkiScore");
const denkiShockBtn = document.getElementById("denkiShockBtn");
const denkiSetBtn = document.getElementById("denkiSetBtn");
denkiSetBtn.disabled = true;
denkiShockBtn.disabled = true;
const denkiSitBtn = document.getElementById("denkiSitBtn");
denkiSitBtn.disabled = true;
const denkiJoinBtn = document.getElementById("denkiJoinBtn");

const denkiConfirmBtn =
  document.getElementById("denkiConfirmBtn");

denkiConfirmBtn.disabled = true;

denkiConfirmBtn.onclick = () => {

  if (!denkiState) return;
  if (selectedSeat === null) return;

  socket.emit("denkiSitConfirm");

  denkiConfirmBtn.disabled = true;
  selectedSeat = null;

};


denkiJoinBtn.onclick = () => {
  socket.emit("denkiJoin");
};




 let denkiState = {};
let myId = null;
let selectedSeat = null; // ★ 仕掛け用に一時保存
denkiShockBtn.onclick = () => {
  socket.emit("denkiShock");
};
denkiSetBtn.onclick = () => {
  if (selectedSeat !== null) {
    socket.emit("denkiSet", selectedSeat);
    selectedSeat = null;
  }
};
denkiSitBtn.onclick = () => {

  if (!denkiState) return;
  if (selectedSeat === null) return;

  // ★ ここでは送信しない
  // 決定ボタンで送信する

  const confirmBtn =
    document.getElementById("denkiConfirmBtn");

  if (confirmBtn){
    confirmBtn.disabled = false;
  }

  denkiSitBtn.disabled = true;

};




/* 椅子12個 */
for (let i = 1; i <= 12; i++) {
  const b = document.createElement("button");
  b.textContent = i;
  b.onclick = () => onDenkiSelect(i);
  denkiBoard.appendChild(b);
}
window.addEventListener("load", () => {
  const savedName  = localStorage.getItem("chatName");
  const savedRoom  = localStorage.getItem("chatRoom");
  const savedColor = localStorage.getItem("chatColor") || "#000000";

  if (savedName && savedRoom) {
    username = savedName;
    myColor = savedColor;
    colorSelect.value = myColor;

    socket.emit("join", {
      name: username,
      color: myColor,
      room: savedRoom
    });

    // 電気椅子UI 即表示（リロード対策）
    socket.emit("denkiStateRequest");

    joined = true;

        // ===== 初回確認済みならチェック非表示 =====
    const confirmed =
      localStorage.getItem(
        "entryConfirmed"
      );

    if (confirmed){
      const loginDiv =
        document.getElementById("login");

      if (loginDiv){
        loginDiv.style.display =
          "none";
      }
    }

    login.style.display = "none";
    chat.style.display = "flex";
  }
});

/* ===== ロビーからの情報 ===== */
const room = localStorage.getItem("chatRoom");

const descEl =
  document.getElementById("roomDesc");

// ===== ダイス表示制御 =====
const diceRow =
  document.getElementById("diceRow");

const showDiceRooms = [
  "room1",
  "room2",
  "room3",
  "room4",
  "room5",
  "room6"
];

if (diceRow){

  if (
    showDiceRooms.includes(room)
  ){
    diceRow.style.display =
      "flex";
  }
  else{
    diceRow.style.display =
      "none";
  }

}


/* ===== 全部屋共通：文字色 ===== */
descEl.style.color = "black";


/* ===== 1〜4 ルール ===== */
const isRoom1to4 =
  ["room1","room2","room3","room4"]
    .includes(room);

if (isRoom1to4) {

descEl.innerHTML =
`〈ルール〉
説明はちゃんと読む事
1-2ルームはサイコロ対決部屋です
埋まってた場合のみ
3-4オナニー部屋を使ってもいいです

ここは制作者ミサのオリジナルチャットです
ミサが知識0から作り
ミサがサバをお金を出して借りてるので
ルールを守れない人は遊ばないで結構ですので帰ってください
部屋に入れない方はブロックされてる方だと思うので黙って帰ってください
---サイコロ対決ルール---
参加者は名前+♂or♀+SorNorMで入室ください
使用するサイコロは
S → 2d6
N → 2d5
M → 2d4
先に3勝で勝利です。勝者の前で罰を受けてください
負けた場合Sだからといって罰は受けない、内緒で行うなど言う方ははじめからやめてください
勝ったので満足と止める人もはじめからしないでください
時間や体力的な問題で途中で止めるのは仕方ないと思いますが。
上記のを確認した場合ブロックします
ルールも守れなかった場合もブロックします
罰回数は基本10回
勝者はボタンを押す前に1/10とその時のカウントを入れること
勝者が「女子罰」「男子罰」のどちらかの罰ボタンを押してください。
敗者は罰を実行してください
時間を計る必要がある場合は敗者が時間ボタン使ってください
パスの回数は敗者の勝利数
罰が終わったあとに 敗者が望めば、絶頂コマンドが使えます
絶頂コマンドは1度のみなので注意してください
(オナ系多め､写真公開はなし)
罰の引き直しはカウントがずれるのでしないこと推奨
ここのチャット以外の外部連れ出し禁止
（ルブルの別部屋、ラブルのツーショ、ライン、カカオなどなど）
命令が被った際は勝利者による自由命令とする
自由命令とありますが、個人情報、写真の要求やNG行為の強要はしない
自分の写真を晒す行為なども禁止します
罰ではありますが敗者も遠慮なくお断りしてください
内緒機能追加しましたが、邪魔にならないように敗者にはしないでください
勝利者がいない場合は15分待って終了
見学者に命令出す権利はありません、煽る程度にしてください
ひどい人はミュートしてください。
下の部屋まで問題ある人は報告くれればブロック対象か考えます
---オナニー部屋ルール---
チャット内上部にある「女オナ」「男オナ」のボタンを押すと指示が出てきます
基本10回
パスは1回までとしてます
見学者は適度な煽りや見守りのみ許可します。過度な言葉責めや要求、指示はしないでください
プレイヤーがイヤな見学者は遠慮なく退出させてください
内緒機能がありますが、邪魔にならないようにプレイヤーには使用しないでください
ルール守れない方は来ないでね

何かあったさいは↓まで<br>
<a href="https://chat.luvul.net/ChatRoom?room_id=424208" target="_blank">
連絡用ルームはこちら
</a>

`;

}


/* ===== 電気椅子 ===== */
const isDenki =
  ["denki","denki1","denki2"]
    .includes(room);

if (isDenki) {

  // ===== 下の罰UIを非表示 =====
  const bottomUI =
    document.getElementById("bottomUI");

  if (bottomUI){
    bottomUI.style.display = "none";
  }


  descEl.innerHTML = `
【電気椅子ルール】<br><br>

2人対戦・観戦可能<br>
ここは制作者ミサのオリジナルチャットです<br>
ミサが知識0から作り<br>
ミサがサバをお金を出して借りてるので<br>
ルールを守れない人は遊ばないで結構ですので帰ってください<br>
部屋に入れない方はブロックされてる方だと思うので黙って帰ってください<br>

仕掛ける側と座る側に分かれます<br>
仕掛ける側は好きな椅子に電流を仕掛けます<br>
座る側は好きな椅子に座ります<br><br>

仕掛けた位置は判定まで非公開<br>
座る位置は確定後に表示されます<br>

判定後<br>
電流だった場合 → 0点＋⚡1<br>
セーフの場合 → 椅子番号が得点になります<br>

勝敗条件<br>
・40点到達<br>
・電流3回被弾<br>
・10ターン終了<br>
・使用済み椅子残り1<br>

負けた場合Sだからといって罰は受けない、内緒で行うなど言う方ははじめからやめてください<br>
勝ったので満足と止める人もはじめからしないでください<br>
時間や体力的な問題で途中で止めるのは仕方ないと思いますが。<br>
上記のを確認した場合ブロックします<br>
ルールも守れなかった場合もブロックします<br>
罰回数は基本10回<br>
勝者はボタンを押す前に1/10とその時のカウントを入れること<br>
勝者が「女子罰」「男子罰」のどちらかの罰ボタンを押してください。<br>
敗者は罰を実行してください<br>
時間を計る必要がある場合は敗者が時間ボタン使ってください<br>
パスの回数は敗者の勝利数<br>
罰が終わったあとに 敗者が望めば、絶頂コマンドが使えます<br>
絶頂コマンドは1度のみなので注意してください<br>
(オナ系多め､写真公開はなし)<br>
罰の引き直しはカウントがずれるのでしないこと推奨<br>
ここのチャット以外の外部連れ出し禁止<br>
（ルブルの別部屋、ラブルのツーショ、ライン、カカオなどなど）<br>
命令が被った際は勝利者による自由命令とする<br>
自由命令が思い浮かばない場合は「男オナ」「女オナ」で代わりもできます。<br>
自由命令とありますが、個人情報、写真の要求やNG行為の強要はしない<br>
自分の写真を晒す行為なども禁止します<br>
罰ではありますが敗者も遠慮なくお断りしてください<br>
内緒機能追加しましたが、邪魔にならないように敗者にはしないでください<br>
勝利者がいない場合は15分待って終了<br>
見学者に命令出す権利はありません、煽る程度にしてください<br>
ひどい人はミュートしてください。<br>
下の部屋まで問題ある人は報告くれればブロック対象か考えます<br>

何かあったさいは↓まで<br>
<a href="https://chat.luvul.net/ChatRoom?room_id=424208" target="_blank">
https://chat.luvul.net/ChatRoom?room_id=424208
</a>
`;
}


const roomNames = {
  room1: "ルーム1",
  room2: "ルーム2",
  room3: "ルーム3",
  room4: "ルーム4",
  room5: "女子部屋",
  room6: "巻き込み",   // ← 追加
  denki: "電気1",
  denki1: "電気椅2",
  denki2: "電気3",
  special: "スペシャル",
  privateA: "個室A",
  privateB: "個室B",
  privateC: "個室C",
  privateD: "個室D"
};


const roomLabel = document.getElementById("roomLabel");

if (roomLabel && room) {
  roomLabel.textContent = `${roomNames[room] || room}`;
}

// ===== 女子部屋制御 =====
if (room === "room5") {

  const boyPunishBtn =
    document.getElementById("boyPunishBtn");

  const boyOnaBtn =
    document.getElementById("boyOnaBtn");

  if (boyPunishBtn){
    boyPunishBtn.style.display = "none";
  }

  if (boyOnaBtn){
    boyOnaBtn.style.display = "none";
  }

}
// ===== 苦痛罰表示制御 =====
const painPunishBtn =
  document.getElementById("painPunishBtn");

if (painPunishBtn){

  if (
    room === "special" ||
    room === "denki"  ||
    room === "denki1" ||
    room === "denki2"
  ){
    painPunishBtn.style.display =
      "inline-block";
  }
  else{
    painPunishBtn.style.display =
      "none";
  }

}


// ===== ルーム6制御（イベントボタン表示） =====
if (room === "room6") {

  const punishWrap =
    document.getElementById("punishWrap");

  const maleEventBtn =
    document.getElementById("maleEventBtn");

  const femaleEventBtn =
    document.getElementById("femaleEventBtn");

  const commonEventBtn =
  document.getElementById("commonEventBtn");


  if (punishWrap){
    punishWrap.style.display = "flex";
  }

  if (maleEventBtn){
    maleEventBtn.style.display = "inline-block";
  }

  if (femaleEventBtn){
    femaleEventBtn.style.display = "inline-block";
  }

  if (commonEventBtn){
  commonEventBtn.style.display = "inline-block";
}

  const girlPunishBtn =
  document.querySelector("button[onclick=\"sendPunish('女子罰')\"]");

const boyPunishBtn =
  document.getElementById("boyPunishBtn");

const girlOnaBtn =
  document.querySelector("button[onclick=\"sendPunish('命令女')\"]");

const boyOnaBtn =
  document.getElementById("boyOnaBtn");

const painBtn =
  document.querySelector("button[onclick=\"sendPunish('苦痛罰')\"]");

if (girlPunishBtn) girlPunishBtn.style.display = "none";
if (boyPunishBtn) boyPunishBtn.style.display = "none";
if (girlOnaBtn)   girlOnaBtn.style.display = "none";
if (boyOnaBtn)    boyOnaBtn.style.display = "none";
if (painBtn)      painBtn.style.display = "none";


}



const key = localStorage.getItem("chatKey");


if (!room && !joined) {
  alert("ロビーから入室してください");
  location.href = "/lobby.html";
}
if (room) roomInfo.textContent = `入室先：${room}`;

/* ===== 表示 ===== */
function renderMsg(d) {
  const li = document.createElement("li");

  if (d.time) {
    const t = document.createElement("span");
    t.textContent = `[${d.time}] `;
    t.className = "time";
    li.appendChild(t);
  }

  const text = document.createElement("span");
  if (d.private) {
    const toName = d.toName || "相手";
    text.textContent = `【内緒】${d.name} ▶ ${toName}: ${d.text}`;
    li.classList.add("private");
  } else {
    text.textContent = `${d.name}: ${d.text}`;
  }

 li.appendChild(text);
li.style.color = d.color || "#000";

if (d.bold) {
  text.style.fontWeight = "bold";
}

messages.prepend(li);

}

/* ===== 受信 ===== */
socket.on("connect", () => {

  myId = socket.id;

  // 電気椅子 状態取得
  socket.emit("denkiStateRequest");

});

socket.on("pastMessages", logs => {

  messages.innerHTML = "";
  logs.forEach(renderMsg);

  // ===== 絶頂解放ログ判定 =====
  const unlocked = logs.some(m =>
    m.text?.includes("絶頂許可が解放されました")
  );

  if (unlocked){
    const btn = document.getElementById("zecchoBtn");
    if (btn) btn.style.display = "inline-block";
  }

});

// ===== 個人ミュート管理 =====
let myMutes = [];

// server から同期（後で拡張用）
socket.on("muteSync", list => {
  myMutes = list || [];
});

socket.on("message", d => {

// ===== ミュート遮断 =====
if (d.name && myMutes.includes(d.name)) {
  return;
}


  // ===== 内緒表示制御 =====
  if (d.private) {
    if (d.to !== myId && d.name !== username) return;
  }

  // ===== 通知音 =====
  if (
    soundLevel !== "off" &&
    d.name &&
    d.name !== username
  ) {
    notifySound.volume =
      SOUND_LEVELS[soundLevel];

    notifySound.currentTime = 0;
    notifySound.play().catch(()=>{});
  }

  renderMsg(d);

});

socket.on("zecchoUnlock", () => {

  const btn = document.getElementById("zecchoBtn");

  if (btn){
    btn.style.display = "inline-block";
  }

});
// ===== タイマー同期 =====
let timerInterval = null;

socket.on("timerSync", ({ endTime }) => {

  const display =
    document.getElementById("timerDisplay");

  if (!display) return;

  display.style.display = "block";

  if (timerInterval){
    clearInterval(timerInterval);
  }

  timerInterval = setInterval(() => {

    const remain =
      Math.max(0, endTime - Date.now());

    const sec =
      Math.floor(remain / 1000);

    const m =
      String(Math.floor(sec / 60))
        .padStart(2,"0");

    const s =
      String(sec % 60)
        .padStart(2,"0");

    display.textContent =
      `⏱ ${m}:${s}`;

    if (remain <= 0){
      clearInterval(timerInterval);
    }

  }, 1000);

});

// ===== タイマー終了 =====
socket.on("timerEnd", () => {

  const display =
    document.getElementById("timerDisplay");

  if (display){
    display.style.display = "none";
  }

  if (timerInterval){
    clearInterval(timerInterval);
  }

});

socket.on("zecchoHide", () => {

  const btn =
    document.getElementById("zecchoBtn");

  if (btn){
    btn.style.display = "none";
  }

});




socket.on("userList", list => {

  userList.innerHTML = "";
  privateTarget.innerHTML =
    `<option value="">なし</option>`;

  list.forEach(u => {

    const li = document.createElement("li");

    // ===== 名前表示 =====
    const nameSpan =
      document.createElement("span");

    nameSpan.textContent = u.name;
    nameSpan.style.color =
      u.color || "#000";

    li.appendChild(nameSpan);

    // ===== 自分以外のみ操作ボタン =====
    if (u.id !== myId) {

      // 内緒用
      const opt =
        document.createElement("option");

      opt.value = u.id;
      opt.textContent = u.name;

      privateTarget.appendChild(opt);

    
   // ===== ミュートボタン =====
const muteBtn =
  document.createElement("button");

// 初期表示
if (myMutes.includes(u.name)) {
  muteBtn.textContent = "済";
} else {
  muteBtn.textContent = "消";
}

muteBtn.style.marginLeft = "6px";
muteBtn.style.padding = "2px 6px";
muteBtn.style.fontSize = "12px";
muteBtn.style.lineHeight = "1.2";

muteBtn.onclick = () => {

  socket.emit("muteUser", u.id);

  // 表示トグル
  if (muteBtn.textContent === "消") {
    muteBtn.textContent = "済";
  } else {
    muteBtn.textContent = "消";
  }

};


      li.appendChild(muteBtn);
    }

    userList.appendChild(li);

  });

});


/* ===== 電気椅子：状態 ===== */
socket.on("denkiState", state => {
  denkiState = state;

  if (!denkiState || !denkiState.players) return;

  updateDenkiUI();
});

function onDenkiSelect(seat) {
  if (!denkiState || !denkiState.players) return;
  if (!denkiState.started) return;   // ← 追加

  const players = denkiState.players || [];

  let me = players.find(p => p.id === myId);

  // ★ IDズレ保険
  if (!me) {
    me = players.find(p => p.name === username);
  }

  if (!me) return;


// ===== ターン本人判定 =====
const turnPlayer =
  denkiState.players[denkiState.turn];

const isMyTurn =
  turnPlayer?.id === myId ||
  turnPlayer?.name === username;


// 仕掛ける側
if (
  denkiState.phase === "set" &&
  isMyTurn
) {

  selectedSeat = seat;

  // ★ 仮選択即描画
  updateDenkiUI();

  return;
}




// ===== 座り仮選択 =====
if (
  denkiState.phase === "sit"
) {

  selectedSeat = seat;

  socket.emit(
    "denkiSit",
    seat
  );

  const sitBtn =
    document.getElementById("denkiSitBtn");

  if (sitBtn){
    sitBtn.disabled = false;
  }

}




}
function updateDenkiUI() {

  denkiWrap.style.display = "block";

  if (
  !denkiState ||
  !denkiState.players
) return;


  const players = denkiState.players;
  const me = players.find(p => p.id === myId); // 観客は undefined


  // ===== ボタン初期状態 =====
  denkiSetBtn.style.display = "inline-block";
  denkiSitBtn.style.display = "inline-block";
  denkiShockBtn.style.display = "inline-block";

  denkiSetBtn.disabled = true;
  denkiSitBtn.disabled = true;
  denkiShockBtn.disabled = true;
  denkiConfirmBtn.disabled = true;
  


  // ===== 観戦モード判定 =====
  const isSpectator = !me;
  // ===== 観戦UI調整 =====
if (isSpectator) {

  denkiSetBtn.style.display = "none";
  denkiSitBtn.style.display = "none";
  denkiShockBtn.style.display = "none";

  denkiStatus.textContent = "👀 観戦中";
}

 

 // ===== プレイヤー操作制御 =====
if (!isSpectator) {

  // ===== ターン本人判定 =====
  const turnPlayer =
    players[denkiState.turn];

  const isMyTurn =
    turnPlayer?.id === myId ||
    turnPlayer?.name === username;


  if (
    denkiState.phase === "set" &&
    isMyTurn
  ) {
    denkiSetBtn.disabled = false;
    denkiStatus.textContent =
      "あなたの番：椅子を仕掛ける";
  }

 else if (
  denkiState.started &&
  denkiState.phase === "sit" &&
  !isMyTurn
) {
  denkiSitBtn.disabled = false;
  denkiStatus.textContent =
    "あなたの番：椅子に座る";
}


  else if (
    denkiState.phase === "shock" &&
    isMyTurn
  ) {
    denkiShockBtn.disabled = false;
    denkiStatus.textContent =
      "⚡ 電流を流してください";
  }

  else {
    denkiStatus.textContent =
      "相手の操作待ち";
  }

}


  // ===== スコア表示 =====
  denkiScore.textContent = players.map(p =>
    `${p.name}: ${p.score}点 / ⚡${p.shock}`
  ).join(" ｜ ");


  // ===== 点数表 =====
  const rowA = document.getElementById("denkiRowA");
  const rowB = document.getElementById("denkiRowB");

  const pA = players[0];
  const pB = players[1];

  if (pA && rowA) {
    rowA.children[0].textContent = pA.name;

    let totalA = 0;

    for (let i = 1; i <= 9; i++) {

      const v = pA.turns?.[i - 1];

      if (v === "shock") {
        rowA.children[i].textContent = "⚡";
        totalA = 0;
      }
      else if (typeof v === "number") {
        rowA.children[i].textContent = v;
        totalA += v;
      }
      else {
        rowA.children[i].textContent = "-";
      }
    }

    rowA.children[10].textContent = totalA;

  }

  if (pB && rowB) {
    rowB.children[0].textContent = pB.name;

    let totalB = 0;

    for (let i = 1; i <= 10; i++) {
      const v = pB.turns?.[i - 1];

      if (v === "shock") {
        rowB.children[i].textContent = "⚡";
        totalB = 0;
      }
      else if (typeof v === "number") {
        rowB.children[i].textContent = v;
        totalB += v;
      }
      else {
        rowB.children[i].textContent = "-";
      }
    }

    rowB.children[10].textContent = totalB;

  }


  // ===== 椅子描画 =====
const buttons = denkiBoard.querySelectorAll("button");
buttons.forEach(b => {

  const num = Number(b.textContent);

  b.style.background = "";
  b.disabled = true;
  b.style.display = "inline-block";

// ===== 自分仮選択色 =====
if (selectedSeat === num) {
  b.style.background = "red";
}



 // 使用済み非表示
if (
  denkiState.usedSeats?.includes(num) &&
  denkiState.phase !== "set"
) {
  b.style.display = "none";
  return;
}


// ===== ターン本人判定 =====
const turnPlayer =
  players[denkiState.turn];

const isMyTurn =
  turnPlayer?.id === myId ||
  turnPlayer?.name === username;


// 仕掛けフェーズ
if (
  denkiState.phase === "set" &&
  isMyTurn
) {
  b.disabled = false;

  // ===== 自分だけ仕掛け色 =====
  if (selectedSeat === num) {
    b.style.background = "red";
  }
}


// 座りフェーズ
if (
  denkiState.phase === "sit" &&
  !isMyTurn &&
  !isSpectator
) {
  b.disabled = false;
}



  // 仮座り表示（全員）
  if (denkiState.sitPreview === num) {
    b.style.background = "#ccccff";
  }

  // 確定座り表示
  if (denkiState.phase === "shock" && denkiState.sitSeat === num) {
    b.style.background = "#ccccff";
  }

});

// ===== 参加ボタン制御 =====
const meJoined =
  denkiState.players.some(p => p.id === myId);

// ===== 試合中判定 =====
const gamePlaying =
  denkiState.started === true &&
  !denkiState.ended;


// ===== 表示制御 =====
if (meJoined || gamePlaying) {
  denkiJoinBtn.style.display = "none";
}
else {
  denkiJoinBtn.style.display = "inline-block";
}


}





// ===== 接続キー生成 =====
let connectKey =
  localStorage.getItem("connectKey");

if (!connectKey){

  connectKey =
    Math.random().toString(36).slice(2) +
    Date.now().toString(36);

  localStorage.setItem(
    "connectKey",
    connectKey
  );

}

/* ===== 入室処理 ===== */
joinBtn.onclick = () => {
  if (joined || !nameInput.value.trim()) return;

    // ===== 確認チェック判定 =====
  const ageCheck =
    document.getElementById("confirmAge");

  const ruleCheck =
    document.getElementById("confirmRule");

  const ipCheck =
    document.getElementById("confirmIp");

  const confirmed =
    localStorage.getItem(
      "entryConfirmed"
    );

  // 初回のみ必須
  if (!confirmed) {

    if (
      !ageCheck?.checked ||
      !ruleCheck?.checked ||
      !ipCheck?.checked
    ){
      alert(
        "確認項目をすべてチェックしてください"
      );
      return;
    }

    localStorage.setItem(
      "entryConfirmed",
      "true"
    );
  }


  username = nameInput.value.trim();
  localStorage.setItem("chatName", username);

  socket.emit("join", {
  name: username,
  color: myColor,
  room,
  key,
  connectKey
});


  // 電気椅子UI 即表示
  socket.emit("denkiStateRequest");

  joined = true;
  login.style.display = "none";
  chat.style.display = "flex";
};

/* ===== 操作 ===== */
colorSelect.oninput = () => {
  myColor = colorSelect.value;
  localStorage.setItem("chatColor", myColor);
  socket.emit("updateColor", { color: myColor });
};

soundSelect.onchange = () => {
  soundLevel = soundSelect.value;
  localStorage.setItem("soundLevel", soundLevel);
};

privateTarget.onchange = () => {
  privateTo = privateTarget.value || "";
};

sendBtn.onclick = () => {
  if (!input.value.trim()) return;
  socket.emit("message", {
    text: input.value.trim(),
    color: myColor,
    to: privateTo || undefined
  });
  input.value = "";
  privateTo = "";
  privateTarget.value = "";
};

input.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});

leaveBtn.onclick = () => {
  socket.emit("leave");
  localStorage.removeItem("chatName");
  localStorage.removeItem("chatRoom");
  localStorage.removeItem("chatKey");
  location.href = "/lobby.html";
};
function sendPunish(cmd){
  socket.emit("message",{ text: cmd });
}
function sendDice(cmd){
  socket.emit("message",{ text: cmd });
}


window.addEventListener("load", () => {

 // ===== 罰トグル（通常） =====
const normalToggle =
  document.getElementById("punishToggleBtn");

const normalWrap =
  document.getElementById("punishWrap");

if (normalToggle && normalWrap){

  let open = false;

  normalToggle.onclick = () => {
    open = !open;
    normalWrap.style.display =
      open ? "flex" : "none";
  };

}


// ===== 罰トグル（電気椅子） =====
const denkiToggle =
  document.getElementById("denkiPunishToggleBtn");

const denkiWrap2 =
  document.getElementById("denkiPunishWrap");

if (denkiToggle && denkiWrap2){

  let open2 = false;

  denkiToggle.onclick = () => {
    open2 = !open2;
    denkiWrap2.style.display =
      open2 ? "flex" : "none";
  };

}

  let punishOpen = false;

  punishToggleBtn.onclick = () => {

    punishOpen = !punishOpen;

    if (punishOpen){
      punishWrap.style.display = "flex";
    } else {
      punishWrap.style.display = "none";
    }

  };

  
  // ===== タイマーボタン（通常と電気分離） =====

// 通常
const normalTimer3Btn =
  document.getElementById("timer3Btn");

const normalTimer5Btn =
  document.getElementById("timer5Btn");

if (normalTimer3Btn){
  normalTimer3Btn.onclick = () => {
    socket.emit("timerStart", { seconds: 180 });
  };
}

if (normalTimer5Btn){
  normalTimer5Btn.onclick = () => {
    socket.emit("timerStart", { seconds: 300 });
  };
}

// 電気椅子
const denkiTimer3Btn =
  document.getElementById("denkiTimer3Btn");

const denkiTimer5Btn =
  document.getElementById("denkiTimer5Btn");

if (denkiTimer3Btn){
  denkiTimer3Btn.onclick = () => {
    socket.emit("timerStart", { seconds: 180 });
  };
}

if (denkiTimer5Btn){
  denkiTimer5Btn.onclick = () => {
    socket.emit("timerStart", { seconds: 300 });
  };
}

const timer5Btn =
  document.getElementById("denkiTimer5Btn")
  || document.getElementById("timer5Btn");

  if (timer3Btn){
    timer3Btn.onclick = () => {
      socket.emit("timerStart", {
        seconds: 180
      });
    };
  }

  if (timer5Btn){
    timer5Btn.onclick = () => {
      socket.emit("timerStart", {
        seconds: 300
      });
    };
  }
// ===== 任意タイマー（通常） =====
const normalTimerCustomBtn =
  document.getElementById("timerCustomBtn");

const normalTimerCustomInput =
  document.getElementById("timerCustomInput");

if (normalTimerCustomBtn){

  normalTimerCustomBtn.onclick = () => {

    const min =
      parseInt(normalTimerCustomInput.value);

    if (!min || min <= 0) return;

    socket.emit("timerStart", {
      seconds: min * 60
    });

    normalTimerCustomInput.value = "";

  };

}

// ===== 任意タイマー（電気椅子） =====
const denkiTimerCustomBtn =
  document.getElementById("denkiTimerCustomBtn");

const denkiTimerCustomInput =
  document.getElementById("denkiTimerCustomInput");

if (denkiTimerCustomBtn){

  denkiTimerCustomBtn.onclick = () => {

    const min =
      parseInt(denkiTimerCustomInput.value);

    if (!min || min <= 0) return;

    socket.emit("timerStart", {
      seconds: min * 60
    });

    denkiTimerCustomInput.value = "";

  };

}

if (timerCustomBtn){

  timerCustomBtn.onclick = () => {

    const min =
      parseInt(timerCustomInput.value);

    if (!min || min <= 0) return;

    socket.emit("timerStart", {
      seconds: min * 60
    });

    timerCustomInput.value = "";

  };

}



});



</script>

</body>
</html>
