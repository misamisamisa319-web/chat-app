<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Chat v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  font-family:
    -apple-system,
    BlinkMacSystemFont,
    "Segoe UI",
    "Hiragino Kaku Gothic ProN",
    "Hiragino Sans",
    "Noto Sans JP",
    Meiryo,
    sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

#login, #chat { flex: 1; display: flex; flex-direction: column; }
#chat { display: none; }

#controls {
  display: flex;
  gap: 5px;
  padding: 5px;
  position: sticky;
  top: 0;
  background: #fff;
  z-index: 10;
}

input, button, select { padding: 10px; font-size: 16px; }

#userList {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  background: #f0f0f0;
  padding: 5px;
  list-style: none;
  max-height: 100px;
  overflow-x: auto;
}

#messages {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  list-style: none;
}

#messages li { margin-bottom: 5px; }
.private { background:#fff3cd; padding:4px; border-radius:4px; }

.time { opacity:.6; margin-right:4px; }

/* ===== 電気椅子 ===== */
#denkiGame {
  margin: 8px;
  padding: 10px;
  background: #bfe3ee;
  border-radius: 8px;
}
#denkiSeats button {
  margin: 4px;
  width: 40px;
  height: 40px;
}
.preview {
  background: orange !important;
  color: #000;
}
</style>
</head>
<body>

<div id="login">
  <h2>入室</h2>
  <input id="nameInput" placeholder="名前">
  <button id="joinBtn">入室</button>
</div>

<div id="chat">
  <div id="controls">
    <input id="input" placeholder="メッセージ">
    <button id="sendBtn">送信</button>
  </div>

  <div id="denkiGame" style="display:none;">
    <strong>⚡ 電気椅子</strong>

    <table border="1" width="100%" style="margin:8px 0;">
      <thead>
        <tr>
          <th>名前</th>
          <th>点数</th>
          <th>被電流</th>
          <th>ターン</th>
        </tr>
      </thead>
      <tbody id="denkiTable"></tbody>
    </table>

    <div id="denkiSeats"></div>

    <button id="denkiSet">仕掛ける</button>
    <button id="denkiSit">座る</button>
    <button id="denkiFire">電流</button>
  </div>

  <strong>参加者</strong>
  <ul id="userList"></ul>

  <ul id="messages"></ul>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let myId = "";
let selectedPreviewSeat = null;

const login = document.getElementById("login");
const chat  = document.getElementById("chat");

const denkiGame = document.getElementById("denkiGame");
const denkiSeats = document.getElementById("denkiSeats");
const denkiTable = document.getElementById("denkiTable");

const denkiSet  = document.getElementById("denkiSet");
const denkiSit  = document.getElementById("denkiSit");
const denkiFire = document.getElementById("denkiFire");

socket.on("connect", ()=> myId = socket.id);

/* ===== チャット ===== */
socket.on("message", d=>{
  const li = document.createElement("li");
  if (d.time) {
    const t = document.createElement("span");
    t.textContent = `[${d.time}] `;
    t.className = "time";
    li.appendChild(t);
  }
  const text = document.createElement("span");
  text.textContent = d.private ? `【内緒】${d.name}: ${d.text}` : `${d.name}: ${d.text}`;
  li.appendChild(text);
  document.getElementById("messages").prepend(li);
});

socket.on("userList", list=>{
  const ul = document.getElementById("userList");
  ul.innerHTML = "";
  list.forEach(u=>{
    const li = document.createElement("li");
    li.textContent = u.name;
    ul.appendChild(li);
  });
});

/* ===== 電気椅子 ===== */
socket.on("denkiState", state=>{
  denkiGame.style.display = "block";
  denkiSeats.innerHTML = "";
  denkiTable.innerHTML = "";

  state.players.forEach(p=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${p.name}</td>
      <td>${p.score}</td>
      <td>${p.shock}</td>
      <td>${p.isTurn ? "●" : ""}</td>
    `;
    denkiTable.appendChild(tr);
  });

  state.remainingSeats.forEach(n=>{
    const b = document.createElement("button");
    b.textContent = n;

    if (state.preview && state.preview.seat === n) {
      b.classList.add("preview");
    }

    b.onclick = ()=>{
      selectedPreviewSeat = n;
      socket.emit("denkiPreview", n);
    };

    denkiSeats.appendChild(b);
  });

  const me = state.players.find(p=>p.id===myId);

  denkiSet.disabled  = !(me?.isTurn && state.phase==="set" && selectedPreviewSeat);
  denkiSit.disabled  = !(state.phase==="sit" && selectedPreviewSeat);
  denkiFire.disabled = !(me?.isTurn && state.phase==="fire");
});

denkiSet.onclick  = ()=> socket.emit("denkiSet", selectedPreviewSeat);
denkiSit.onclick  = ()=> socket.emit("denkiSit");
denkiFire.onclick = ()=> socket.emit("denkiFire");

/* ===== 入室 ===== */
document.getElementById("joinBtn").onclick = ()=>{
  const name = document.getElementById("nameInput").value.trim();
  if (!name) return;
  socket.emit("join", { name, room: localStorage.getItem("chatRoom") });
  login.style.display = "none";
  chat.style.display = "flex";
};

document.getElementById("sendBtn").onclick = ()=>{
  const input = document.getElementById("input");
  if (!input.value.trim()) return;
  socket.emit("message", { text: input.value });
  input.value = "";
};
</script>
</body>
</html>
