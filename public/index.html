<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Chat v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  font-family: system-ui, sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

#login, #chat { flex: 1; display: flex; flex-direction: column; }
#chat { display: none; }

#controls { display:flex; gap:5px; padding:5px; background:#fff; }
#messages { flex:1; overflow-y:auto; list-style:none; padding:10px; }
#messages li { margin-bottom:4px; }

.time { opacity:.6; margin-right:4px; }
.private { background:#fff3cd; padding:2px 4px; border-radius:4px; }

#userList { display:flex; gap:8px; flex-wrap:wrap; list-style:none; padding:5px; background:#f0f0f0; }

#settings {
  display:flex; gap:8px; flex-wrap:wrap;
  padding:5px; background:#f9f9f9; border-top:1px solid #ccc;
}

/* ===== 電気椅子 ===== */
#denki {
  border:2px solid #f90;
  margin:8px;
  padding:8px;
  border-radius:8px;
  background:#fffaf0;
}
#denkiSeats button {
  margin:3px;
  width:40px;
  height:40px;
}
.turn { font-weight:bold; color:#f00; }
</style>
</head>
<body>

<div id="login">
  <h2>入室</h2>
  <input id="nameInput" placeholder="名前">
  <button id="joinBtn">入室</button>
</div>

<div id="chat">
  <div id="controls">
    <input id="input" placeholder="メッセージ">
    <button id="sendBtn">送信</button>
  </div>

  <!-- ⚡ 電気椅子 -->
  <div id="denki" style="display:none">
    <div id="denkiInfo"></div>
    <div id="denkiSeats"></div>
    <button id="denkiSetBtn" disabled>仕掛ける</button>
    <button id="denkiSitBtn" disabled>座る</button>
    <button id="denkiFireBtn" disabled>電流を流す</button>
  </div>

  <ul id="userList"></ul>

  <div id="settings">
    <label>文字色 <input type="color" id="colorSelect"></label>
    <label>内緒
      <select id="privateTarget">
        <option value="">なし</option>
      </select>
    </label>
  </div>

  <ul id="messages"></ul>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

/* ===== 共通 ===== */
const login = document.getElementById("login");
const chat  = document.getElementById("chat");
const nameInput = document.getElementById("nameInput");
const joinBtn = document.getElementById("joinBtn");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const messages = document.getElementById("messages");
const userList = document.getElementById("userList");
const privateTarget = document.getElementById("privateTarget");
const colorSelect = document.getElementById("colorSelect");

let username = "";
let myColor = "#000000";
let privateTo = "";

/* ===== 電気椅子 ===== */
const denkiBox = document.getElementById("denki");
const denkiInfo = document.getElementById("denkiInfo");
const denkiSeats = document.getElementById("denkiSeats");
const setBtn = document.getElementById("denkiSetBtn");
const sitBtn = document.getElementById("denkiSitBtn");
const fireBtn = document.getElementById("denkiFireBtn");

let selectedSeat = null;
let myId = null;
let currentDenkiState = null;

/* ===== 表示 ===== */
function renderMsg(d){
  const li = document.createElement("li");
  if (d.time) {
    const t = document.createElement("span");
    t.textContent = `[${d.time}] `;
    t.className = "time";
    li.appendChild(t);
  }
  const s = document.createElement("span");
  s.textContent = d.private
    ? `【内緒】${d.name}: ${d.text}`
    : `${d.name}: ${d.text}`;
  li.appendChild(s);
  li.style.color = d.color || "#000";
  messages.prepend(li);
}

/* ===== Socket ===== */
socket.on("connect", ()=>{ myId = socket.id; });

socket.on("pastMessages", logs=>{
  messages.innerHTML = "";
  logs.forEach(renderMsg);
});

socket.on("message", d=>{
  if (d.private && d.to !== myId && d.name !== username) return;
  renderMsg(d);
});

socket.on("userList", list=>{
  userList.innerHTML = "";
  privateTarget.innerHTML = `<option value="">なし</option>`;
  list.forEach(u=>{
    const li = document.createElement("li");
    li.textContent = u.name;
    li.style.color = u.color;
    userList.appendChild(li);
    if (u.id !== myId) {
      const o = document.createElement("option");
      o.value = u.id;
      o.textContent = u.name;
      privateTarget.appendChild(o);
    }
  });
});

/* ===== 電気椅子状態 ===== */
socket.on("denkiState", state=>{
  denkiBox.style.display = "block";
  currentDenkiState = state;
  denkiSeats.innerHTML = "";
  selectedSeat = null;

  state.remainingSeats.forEach(n=>{
    const b = document.createElement("button");
    b.textContent = n;
    b.onclick = ()=> selectedSeat = n;
    denkiSeats.appendChild(b);
  });

  const me = state.players.find(p=>p.id===myId);
  const isTurn = me?.isTurn;
  denkiInfo.innerHTML = state.players.map(p=>
    `${p.name}: ${p.score}点 / 電流${p.shock}${p.isTurn?" ←ターン":""}`
  ).join("<br>");

  setBtn.disabled  = !(isTurn && state.phase==="set");
  sitBtn.disabled  = !(state.phase==="sit" && !isTurn);
  fireBtn.disabled = !(isTurn && state.phase==="fire");
});

/* ===== 電気椅子操作 ===== */
setBtn.onclick = ()=> selectedSeat && socket.emit("denkiSet", selectedSeat);
sitBtn.onclick = ()=> selectedSeat && socket.emit("denkiSit", selectedSeat);
fireBtn.onclick = ()=> socket.emit("denkiFire");

/* ===== 操作 ===== */
joinBtn.onclick = ()=>{
  username = nameInput.value.trim();
  if (!username) return;
  socket.emit("join", { name: username, color: myColor, room: localStorage.getItem("chatRoom") });
  login.style.display = "none";
  chat.style.display = "flex";
};

sendBtn.onclick = ()=>{
  if (!input.value.trim()) return;
  socket.emit("message", { text: input.value, color: myColor, to: privateTo||undefined });
  input.value = "";
  privateTo = "";
};

privateTarget.onchange = ()=> privateTo = privateTarget.value;
colorSelect.oninput = ()=> {
  myColor = colorSelect.value;
  socket.emit("updateColor", { color: myColor });
};
</script>
</body>
</html>
