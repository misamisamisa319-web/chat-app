<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Chat v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  font-family:
    -apple-system,
    BlinkMacSystemFont,
    "Segoe UI",
    "Hiragino Kaku Gothic ProN",
    "Hiragino Sans",
    "Noto Sans JP",
    Meiryo,
    sans-serif;
  height: 100vh;
  display: flex;
  flex-direction: column;
}

#login, #chat { flex: 1; display: flex; flex-direction: column; }
#chat { display: none; }

.system { color: gray; }
.system.girl { color: red; font-weight: bold; }
.system.boy { color: blue; font-weight: bold; }

#controls { display: flex; gap: 5px; padding: 5px; position: sticky; top: 0; background: #fff; z-index: 10; }
input, button, select { padding: 10px; font-size: 16px; }
#punishWrap {
  gap: 20px;   /* ãƒœã‚¿ãƒ³åŒå£«ã®é–“éš” */
}
#punishWrap button {
  padding: 6px 12px;  /* ãƒœã‚¿ãƒ³ã®ä¸­ã®ä½™ç™½ */
  font-size: 16px;   /* æ–‡å­—ã‚µã‚¤ã‚º */
}


#userList {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  background: #f0f0f0;
  padding: 5px;
  list-style: none;
  align-items: center;
}

#userList li {
  padding: 3px 8px;
  border-radius: 5px;
  white-space: nowrap;
}


#settings { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; padding: 5px; background: #f9f9f9; border-bottom: 1px solid #ccc; }
#settings input, #settings button, #settings select { padding: 5px; font-size: 14px; }

#messages { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding: 10px; list-style: none; padding-bottom: 180px; /* â† ã“ã‚Œã‚’è¿½åŠ  */ }
#messages li { margin-bottom: 5px; }
.private { background: #fff3cd; padding: 3px 6px; border-radius: 4px; }

.time { opacity: .6; margin-right: 4px; }

/* ===== é›»æ°—æ¤…å­UI ===== */
#denkiWrap {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;

  margin: 0;
  padding: 10px;
  background: #e8f5fb;
  border-radius: 8px 8px 0 0;

  display: none;
  z-index: 50;
}


#denkiHeader {
  font-weight: bold;
  margin-bottom: 6px;
}
#denkiStatus {
  margin-bottom: 6px;
}
#denkiBoard {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 8px;
}
#denkiBoard button {
  width: 44px;
}
#denkiScore {
  font-size: 14px;
  margin-bottom: 6px;
}
</style>
</head>
<body>

<div id="login">
  <h2>å…¥å®¤</h2>
  <div id="roomInfo" style="margin-bottom:10px; color:#555;"></div>
  <input id="nameInput" placeholder="åå‰">
  <button id="joinBtn">å…¥å®¤</button>
</div>

<div id="chat">
 <div id="controls">
  <input id="input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸">
  <button id="sendBtn">é€ä¿¡</button>

  <span id="roomLabel"
    style="padding:10px; font-weight:bold;">
  </span>
</div>


  <!-- âš¡ é›»æ°—æ¤…å­ï¼ˆdenki ãƒ«ãƒ¼ãƒ ã®ã¿è¡¨ç¤ºï¼‰ -->
  <div id="denkiWrap">
    <!-- ===== é›»æ°—æ¤…å­ ç‚¹æ•°è¡¨ ===== -->
<table id="denkiTable" style="
  width:100%;
  border-collapse:collapse;
  margin-bottom:10px;
  font-size:14px;
">
  <thead>
    <tr>
      <th style="border:1px solid #999;">åå‰</th>
      <th style="border:1px solid #999;">1</th>
      <th style="border:1px solid #999;">2</th>
      <th style="border:1px solid #999;">3</th>
      <th style="border:1px solid #999;">4</th>
      <th style="border:1px solid #999;">5</th>
      <th style="border:1px solid #999;">6</th>
      <th style="border:1px solid #999;">7</th>
      <th style="border:1px solid #999;">8</th>
      <th style="border:1px solid #999;">9</th>
      <th style="border:1px solid #999;">åˆè¨ˆ</th>
    </tr>
  </thead>
  <tbody>
    <tr id="denkiRowA">
      <td style="border:1px solid #999;">A</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">0</td>
    </tr>
    <tr id="denkiRowB">
      <td style="border:1px solid #999;">B</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">-</td>
      <td style="border:1px solid #999;">0</td>
    </tr>
  </tbody>
</table>

    <div id="denkiStatus">å¾…æ©Ÿä¸­</div>
    <div id="denkiScore"></div>
    <div id="denkiBoard"></div>
    <button id="denkiJoinBtn">å‚åŠ </button>
<button id="denkiSetBtn">ä»•æ›ã‘ã‚‹</button>
<button id="denkiShockBtn">âš¡ é›»æµæµã™</button>
<button id="denkiSitBtn">åº§ã‚‹</button>





  </div>
<!-- ===== å‚åŠ è€… ===== -->
<div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
  <strong>å‚åŠ è€…:</strong>
  <ul id="userList"></ul>
</div>
<!-- ===== ç½°ãƒˆã‚°ãƒ« ===== -->
<button id="punishToggleBtn">
  ç½°ãƒ¡ãƒ‹ãƒ¥ãƒ¼
 </button>

<!-- ===== ç½°ãƒœã‚¿ãƒ³ ===== -->
<div id="punishWrap" style="
  display:none;
  gap:7px;
  flex-wrap:wrap;
  padding:6px 0;">
  <button onclick="sendPunish('å¥³å­ç½°')">å¥³å­ç½°</button>
  <button id="boyPunishBtn"
        onclick="sendPunish('ç”·å­ç½°')">
ç”·å­ç½°
</button>
  <button onclick="sendPunish('å‘½ä»¤å¥³')">å¥³ã‚ªãƒŠ</button>
  <button id="boyOnaBtn"
        onclick="sendPunish('å‘½ä»¤ç”·')">
ç”·ã‚ªãƒŠ
</button>
  <button onclick="sendPunish('è‹¦ç—›ç½°')">è‹¦ç—›ç½°</button>
  <button id="zecchoBtn"
        onclick="sendPunish('çµ¶é ‚è¨±å¯')"
        style="display:none;">
  çµ¶é ‚è¨±å¯
</button>
<button id="maleEventBtn"
        style="display:none;"
        onclick="sendPunish('ç”·ã‚¤ãƒ™ãƒ³ãƒˆ')">
  ç”·ã‚¤ãƒ™ãƒ³ãƒˆ
</button>

<button id="femaleEventBtn"
        style="display:none;"
        onclick="sendPunish('å¥³ã‚¤ãƒ™ãƒ³ãƒˆ')">
  å¥³ã‚¤ãƒ™ãƒ³ãƒˆ
</button>

</div>





  <div id="settings">
    <label>è‰²: <input type="color" id="colorSelect" value="#000000"></label>
    <label>å†…ç·’:
      <select id="privateTarget">
        <option value="">ãªã—</option>
      </select>
    </label>
    <label>
      éŸ³:
      <select id="soundSelect">
        <option value="off">OFF</option>
        <option value="small">å°</option>
        <option value="medium">ä¸­</option>
        <option value="large">å¤§</option>
      </select>
    </label>
    <button id="leaveBtn">é€€å‡º</button>
  </div>

  <ul id="messages"></ul>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

const login = document.getElementById("login");
const chat = document.getElementById("chat");
const joinBtn = document.getElementById("joinBtn");
const nameInput = document.getElementById("nameInput");
const roomInfo = document.getElementById("roomInfo");

const messages = document.getElementById("messages");
const input = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const leaveBtn = document.getElementById("leaveBtn");
const userList = document.getElementById("userList");
const colorSelect = document.getElementById("colorSelect");
const privateTarget = document.getElementById("privateTarget");
const soundSelect = document.getElementById("soundSelect");

const notifySound = new Audio("/notify.mp3");
const SOUND_LEVELS = { off:0, small:0.2, medium:0.5, large:1.0 };
let soundLevel = localStorage.getItem("soundLevel") || "off";
soundSelect.value = soundLevel;

let username = "";
let myColor = "#000000";
let privateTo = "";
let joined = false;

/* ===== é›»æ°—æ¤…å­DOM ===== */
const denkiWrap = document.getElementById("denkiWrap");
const denkiStatus = document.getElementById("denkiStatus");
const denkiBoard = document.getElementById("denkiBoard");
const denkiScore = document.getElementById("denkiScore");
const denkiShockBtn = document.getElementById("denkiShockBtn");
const denkiSetBtn = document.getElementById("denkiSetBtn");
denkiSetBtn.disabled = true;
denkiShockBtn.disabled = true;
const denkiSitBtn = document.getElementById("denkiSitBtn");
denkiSitBtn.disabled = true;
const denkiJoinBtn = document.getElementById("denkiJoinBtn");

denkiJoinBtn.onclick = () => {
  socket.emit("denkiJoin");
};




 let denkiState = {};
let myId = null;
let selectedSeat = null; // â˜… ä»•æ›ã‘ç”¨ã«ä¸€æ™‚ä¿å­˜
denkiShockBtn.onclick = () => {
  socket.emit("denkiShock");
};
denkiSetBtn.onclick = () => {
  if (selectedSeat !== null) {
    socket.emit("denkiSet", selectedSeat);
    selectedSeat = null;
  }
};
denkiSitBtn.onclick = () => {

  if (!denkiState) return;

  socket.emit("denkiSitConfirm");

};


/* æ¤…å­12å€‹ */
for (let i = 1; i <= 12; i++) {
  const b = document.createElement("button");
  b.textContent = i;
  b.onclick = () => onDenkiSelect(i);
  denkiBoard.appendChild(b);
}
window.addEventListener("load", () => {
  const savedName  = localStorage.getItem("chatName");
  const savedRoom  = localStorage.getItem("chatRoom");
  const savedColor = localStorage.getItem("chatColor") || "#000000";

  if (savedName && savedRoom) {
    username = savedName;
    myColor = savedColor;
    colorSelect.value = myColor;

    socket.emit("join", {
      name: username,
      color: myColor,
      room: savedRoom
    });

    // é›»æ°—æ¤…å­UI å³è¡¨ç¤ºï¼ˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–ï¼‰
    socket.emit("denkiStateRequest");

    joined = true;
    login.style.display = "none";
    chat.style.display = "flex";
  }
});

/* ===== ãƒ­ãƒ“ãƒ¼ã‹ã‚‰ã®æƒ…å ± ===== */
const room = localStorage.getItem("chatRoom");

const roomNames = {
  room1: "ãƒ«ãƒ¼ãƒ 1",
  room2: "ãƒ«ãƒ¼ãƒ 2",
  room3: "ãƒ«ãƒ¼ãƒ 3",
  room4: "ãƒ«ãƒ¼ãƒ 4",
  room5: "å¥³å­éƒ¨å±‹",
  room6: "å·»ãè¾¼ã¿",   // â† è¿½åŠ 
  denki: "é›»æ°—1",
  denki1: "é›»æ°—æ¤…2",
  denki2: "é›»æ°—3",
  special: "ã‚¹ãƒšã‚·ãƒ£ãƒ«",
  privateA: "å€‹å®¤A",
  privateB: "å€‹å®¤B",
  privateC: "å€‹å®¤C",
  privateD: "å€‹å®¤D"
};


const roomLabel = document.getElementById("roomLabel");

if (roomLabel && room) {
  roomLabel.textContent = `${roomNames[room] || room}`;
}

// ===== å¥³å­éƒ¨å±‹åˆ¶å¾¡ =====
if (room === "room5") {

  const boyPunishBtn =
    document.getElementById("boyPunishBtn");

  const boyOnaBtn =
    document.getElementById("boyOnaBtn");

  if (boyPunishBtn){
    boyPunishBtn.style.display = "none";
  }

  if (boyOnaBtn){
    boyOnaBtn.style.display = "none";
  }

}


// ===== ãƒ«ãƒ¼ãƒ 6åˆ¶å¾¡ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒœã‚¿ãƒ³è¡¨ç¤ºï¼‰ =====
if (room === "room6") {

  const punishWrap =
    document.getElementById("punishWrap");

  const maleEventBtn =
    document.getElementById("maleEventBtn");

  const femaleEventBtn =
    document.getElementById("femaleEventBtn");

  if (punishWrap){
    punishWrap.style.display = "flex";
  }

  if (maleEventBtn){
    maleEventBtn.style.display = "inline-block";
  }

  if (femaleEventBtn){
    femaleEventBtn.style.display = "inline-block";
  }

}



const key = localStorage.getItem("chatKey");


if (!room && !joined) {
  alert("ãƒ­ãƒ“ãƒ¼ã‹ã‚‰å…¥å®¤ã—ã¦ãã ã•ã„");
  location.href = "/lobby.html";
}
if (room) roomInfo.textContent = `å…¥å®¤å…ˆï¼š${room}`;

/* ===== è¡¨ç¤º ===== */
function renderMsg(d) {
  const li = document.createElement("li");

  if (d.time) {
    const t = document.createElement("span");
    t.textContent = `[${d.time}] `;
    t.className = "time";
    li.appendChild(t);
  }

  const text = document.createElement("span");
  if (d.private) {
    const toName = d.toName || "ç›¸æ‰‹";
    text.textContent = `ã€å†…ç·’ã€‘${d.name} â–¶ ${toName}: ${d.text}`;
    li.classList.add("private");
  } else {
    text.textContent = `${d.name}: ${d.text}`;
  }

 li.appendChild(text);
li.style.color = d.color || "#000";

if (d.bold) {
  text.style.fontWeight = "bold";
}

messages.prepend(li);

}

/* ===== å—ä¿¡ ===== */
socket.on("connect", () => {

  myId = socket.id;

  // é›»æ°—æ¤…å­ çŠ¶æ…‹å–å¾—
  socket.emit("denkiStateRequest");

});

socket.on("pastMessages", logs => {

  messages.innerHTML = "";
  logs.forEach(renderMsg);

  // ===== çµ¶é ‚è§£æ”¾ãƒ­ã‚°åˆ¤å®š =====
  const unlocked = logs.some(m =>
    m.text?.includes("çµ¶é ‚è¨±å¯ãŒè§£æ”¾ã•ã‚Œã¾ã—ãŸ")
  );

  if (unlocked){
    const btn = document.getElementById("zecchoBtn");
    if (btn) btn.style.display = "inline-block";
  }

});

// ===== å€‹äººãƒŸãƒ¥ãƒ¼ãƒˆç®¡ç† =====
let myMutes = [];

// server ã‹ã‚‰åŒæœŸï¼ˆå¾Œã§æ‹¡å¼µç”¨ï¼‰
socket.on("muteSync", list => {
  myMutes = list || [];
});

socket.on("message", d => {

// ===== ãƒŸãƒ¥ãƒ¼ãƒˆé®æ–­ =====
if (d.name && myMutes.includes(d.name)) {
  return;
}


  // ===== å†…ç·’è¡¨ç¤ºåˆ¶å¾¡ =====
  if (d.private) {
    if (d.to !== myId && d.name !== username) return;
  }

  // ===== é€šçŸ¥éŸ³ =====
  if (
    soundLevel !== "off" &&
    d.name &&
    d.name !== username
  ) {
    notifySound.volume =
      SOUND_LEVELS[soundLevel];

    notifySound.currentTime = 0;
    notifySound.play().catch(()=>{});
  }

  renderMsg(d);

});

socket.on("zecchoUnlock", () => {

  const btn = document.getElementById("zecchoBtn");

  if (btn){
    btn.style.display = "inline-block";
  }

});



socket.on("userList", list => {

  userList.innerHTML = "";
  privateTarget.innerHTML =
    `<option value="">ãªã—</option>`;

  list.forEach(u => {

    const li = document.createElement("li");

    // ===== åå‰è¡¨ç¤º =====
    const nameSpan =
      document.createElement("span");

    nameSpan.textContent = u.name;
    nameSpan.style.color =
      u.color || "#000";

    li.appendChild(nameSpan);

    // ===== è‡ªåˆ†ä»¥å¤–ã®ã¿æ“ä½œãƒœã‚¿ãƒ³ =====
    if (u.id !== myId) {

      // å†…ç·’ç”¨
      const opt =
        document.createElement("option");

      opt.value = u.id;
      opt.textContent = u.name;

      privateTarget.appendChild(opt);

    
   // ===== ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³ =====
const muteBtn =
  document.createElement("button");

// åˆæœŸè¡¨ç¤º
if (myMutes.includes(u.name)) {
  muteBtn.textContent = "æ¸ˆ";
} else {
  muteBtn.textContent = "æ¶ˆ";
}

muteBtn.style.marginLeft = "6px";
muteBtn.style.padding = "2px 6px";
muteBtn.style.fontSize = "12px";
muteBtn.style.lineHeight = "1.2";

muteBtn.onclick = () => {

  socket.emit("muteUser", u.id);

  // è¡¨ç¤ºãƒˆã‚°ãƒ«
  if (muteBtn.textContent === "æ¶ˆ") {
    muteBtn.textContent = "æ¸ˆ";
  } else {
    muteBtn.textContent = "æ¶ˆ";
  }

};


      li.appendChild(muteBtn);
    }

    userList.appendChild(li);

  });

});


/* ===== é›»æ°—æ¤…å­ï¼šçŠ¶æ…‹ ===== */
socket.on("denkiState", state => {
  denkiState = state;

  if (!denkiState || !denkiState.players) return;

  updateDenkiUI();
});

function onDenkiSelect(seat) {
  if (!denkiState || !denkiState.players) return;

  const players = denkiState.players || [];

  let me = players.find(p => p.id === myId);

  // â˜… IDã‚ºãƒ¬ä¿é™º
  if (!me) {
    me = players.find(p => p.name === username);
  }

  if (!me) return;


  // ä»•æ›ã‘ã‚‹å´
 if (
  denkiState.started === true &&
  denkiState.phase === "set" &&
  me &&
  (
    me.isTurn ||
    denkiState.players[denkiState.turn]?.id === myId ||

    denkiState.players[denkiState.turn]?.name === username
  )
) {
  selectedSeat = seat;
  updateDenkiUI();
  return;
}


  // åº§ã‚‹ãƒ•ã‚§ãƒ¼ã‚ºã¯ç„¡æ¡ä»¶ã§é€ã‚‹ï¼ˆåˆ¤å®šã¯ã‚µãƒ¼ãƒãƒ¼å´ï¼‰
if (
  denkiState.started === true &&
  denkiState.phase === "sit"
) {
  socket.emit("denkiSit", seat);
}

}
function updateDenkiUI() {

  denkiWrap.style.display = "block";

  if (
  !denkiState ||
  !denkiState.players
) return;


  const players = denkiState.players;
  const me = players.find(p => p.id === myId); // è¦³å®¢ã¯ undefined


  // ===== ãƒœã‚¿ãƒ³åˆæœŸçŠ¶æ…‹ =====
  denkiSetBtn.style.display = "inline-block";
  denkiSitBtn.style.display = "inline-block";
  denkiShockBtn.style.display = "inline-block";

  denkiSetBtn.disabled = true;
  denkiSitBtn.disabled = true;
  denkiShockBtn.disabled = true;

  // ===== è¦³æˆ¦ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š =====
  const isSpectator = !me;
  // ===== è¦³æˆ¦UIèª¿æ•´ =====
if (isSpectator) {

  denkiSetBtn.style.display = "none";
  denkiSitBtn.style.display = "none";
  denkiShockBtn.style.display = "none";

  denkiStatus.textContent = "ğŸ‘€ è¦³æˆ¦ä¸­";
}

  // ===== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ“ä½œåˆ¶å¾¡ =====
  if (!isSpectator) {

    if (
      denkiState.started === true &&
      denkiState.phase === "set" &&
  me &&
  (
    me.isTurn ||
    players[denkiState.turn]?.id === myId ||
    players[denkiState.turn]?.name === username
  )
) {
  denkiSetBtn.disabled = false;
  denkiStatus.textContent = "ã‚ãªãŸã®ç•ªï¼šæ¤…å­ã‚’ä»•æ›ã‘ã‚‹";
}

 else if (
  denkiState.phase === "sit" &&
  me &&
  !me.isTurn
) {
  denkiSitBtn.disabled = false;
  denkiStatus.textContent = "ã‚ãªãŸã®ç•ªï¼šæ¤…å­ã«åº§ã‚‹";
}


  else if (
  denkiState.phase === "shock" &&
  me &&
  (
    me.isTurn ||
    players[denkiState.turn]?.id === myId ||
    players[denkiState.turn]?.name === username
  )
) {
  denkiShockBtn.disabled = false;
  denkiStatus.textContent = "âš¡ é›»æµã‚’æµã—ã¦ãã ã•ã„";
}
   

    else if (!isSpectator) {
      denkiStatus.textContent = "ç›¸æ‰‹ã®æ“ä½œå¾…ã¡";
    }

  }

  // ===== ã‚¹ã‚³ã‚¢è¡¨ç¤º =====
  denkiScore.textContent = players.map(p =>
    `${p.name}: ${p.score}ç‚¹ / âš¡${p.shock}`
  ).join(" ï½œ ");


  // ===== ç‚¹æ•°è¡¨ =====
  const rowA = document.getElementById("denkiRowA");
  const rowB = document.getElementById("denkiRowB");

  const pA = players[0];
  const pB = players[1];

  if (pA && rowA) {
    rowA.children[0].textContent = pA.name;

    let totalA = 0;

    for (let i = 1; i <= 9; i++) {

      const v = pA.turns?.[i - 1];

      if (v === "shock") {
        rowA.children[i].textContent = "âš¡";
        totalA = 0;
      }
      else if (typeof v === "number") {
        rowA.children[i].textContent = v;
        totalA += v;
      }
      else {
        rowA.children[i].textContent = "-";
      }
    }

    rowA.children[10].textContent = totalA;

  }

  if (pB && rowB) {
    rowB.children[0].textContent = pB.name;

    let totalB = 0;

    for (let i = 1; i <= 10; i++) {
      const v = pB.turns?.[i - 1];

      if (v === "shock") {
        rowB.children[i].textContent = "âš¡";
        totalB = 0;
      }
      else if (typeof v === "number") {
        rowB.children[i].textContent = v;
        totalB += v;
      }
      else {
        rowB.children[i].textContent = "-";
      }
    }

    rowB.children[10].textContent = totalB;

  }


  // ===== æ¤…å­æç”» =====
const buttons = denkiBoard.querySelectorAll("button");

buttons.forEach(b => {

  const num = Number(b.textContent);

  b.style.background = "";
  b.disabled = true;
  b.style.display = "inline-block";

  // ä½¿ç”¨æ¸ˆã¿éè¡¨ç¤º
  if (denkiState.usedSeats?.includes(num)) {
    b.style.display = "none";
    return;
  }

  // è¦³æˆ¦è€…ã¯æ“ä½œä¸å¯ã ãŒä»®åº§ã‚Šã¯è¦‹ãˆã‚‹
  if (isSpectator) {
    if (denkiState.sitPreview === num) {
      b.style.background = "#ccccff";
    }
    return;
  }

  // ä»•æ›ã‘ãƒ•ã‚§ãƒ¼ã‚º
if (
  denkiState.started === true &&
  denkiState.phase === "set" &&
  me.isTurn
) {
  b.disabled = false;

  if (selectedSeat === num) {
    b.style.background = "#ffe066";
  }
}


  // åº§ã‚Šãƒ•ã‚§ãƒ¼ã‚º
if (
  denkiState.phase === "sit" &&
  me &&
  (
    !me.isTurn ||
    denkiState.players[denkiState.turn]?.id !== myId ||
    denkiState.players[denkiState.turn]?.name !== username
  )
) {
  b.disabled = false;
}



  // ä»®åº§ã‚Šè¡¨ç¤ºï¼ˆå…¨å“¡ï¼‰
  if (denkiState.sitPreview === num) {
    b.style.background = "#ccccff";
  }

  // ç¢ºå®šåº§ã‚Šè¡¨ç¤º
  if (denkiState.phase === "shock" && denkiState.sitSeat === num) {
    b.style.background = "#ccccff";
  }

});

// ===== å‚åŠ ãƒœã‚¿ãƒ³åˆ¶å¾¡ =====
const meJoined =
  denkiState.players.some(p => p.id === myId);

// ===== è©¦åˆä¸­åˆ¤å®š =====
const gamePlaying =
  denkiState.started === true &&
  !denkiState.ended;


// ===== è¡¨ç¤ºåˆ¶å¾¡ =====
if (meJoined || gamePlaying) {
  denkiJoinBtn.style.display = "none";
}
else {
  denkiJoinBtn.style.display = "inline-block";
}


}






/* ===== å…¥å®¤å‡¦ç† ===== */
joinBtn.onclick = () => {
  if (joined || !nameInput.value.trim()) return;

  username = nameInput.value.trim();
  localStorage.setItem("chatName", username);

  socket.emit("join", {
    name: username,
    color: myColor,
    room,
    key
  });

  // é›»æ°—æ¤…å­UI å³è¡¨ç¤º
  socket.emit("denkiStateRequest");

  joined = true;
  login.style.display = "none";
  chat.style.display = "flex";
};

/* ===== æ“ä½œ ===== */
colorSelect.oninput = () => {
  myColor = colorSelect.value;
  localStorage.setItem("chatColor", myColor);
  socket.emit("updateColor", { color: myColor });
};

soundSelect.onchange = () => {
  soundLevel = soundSelect.value;
  localStorage.setItem("soundLevel", soundLevel);
};

privateTarget.onchange = () => {
  privateTo = privateTarget.value || "";
};

sendBtn.onclick = () => {
  if (!input.value.trim()) return;
  socket.emit("message", {
    text: input.value.trim(),
    color: myColor,
    to: privateTo || undefined
  });
  input.value = "";
  privateTo = "";
  privateTarget.value = "";
};

input.addEventListener("keydown", e => {
  if (e.key === "Enter" && !e.shiftKey) {
    e.preventDefault();
    sendBtn.click();
  }
});

leaveBtn.onclick = () => {
  socket.emit("leave");
  localStorage.removeItem("chatName");
  localStorage.removeItem("chatRoom");
  localStorage.removeItem("chatKey");
  location.href = "/lobby.html";
};
function sendPunish(cmd){
  socket.emit("message",{ text: cmd });
}
/* ===== ç½°ãƒˆã‚°ãƒ« ===== */
window.addEventListener("load", () => {

  const punishToggleBtn =
    document.getElementById("punishToggleBtn");

  const punishWrap =
    document.getElementById("punishWrap");

  let punishOpen = false;

  punishToggleBtn.onclick = () => {

    punishOpen = !punishOpen;

    if (punishOpen){
      punishWrap.style.display = "flex";
    } else {
      punishWrap.style.display = "none";
    }

  };

});

</script>

</body>
</html>
