<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ロビー</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  font-family:
    -apple-system,
    BlinkMacSystemFont,
    "Segoe UI",
    "Hiragino Kaku Gothic ProN",
    "Hiragino Sans",
    "Noto Sans JP",
    Meiryo,
    sans-serif;
  padding: 20px;
}
.room {
  border: 1px solid #ccc;
  padding: 10px;
  margin-bottom: 12px;
}
.room-title {
  font-weight: bold;
  margin-bottom: 4px;
}
.room-info {
  font-size: 14px;
  margin-bottom: 6px;
}
button {
  padding: 6px 12px;
  margin-right: 5px;
}
input[type="password"] {
  padding: 5px;
  width: 120px;
}
</style>
</head>
<body>

<h2>ロビー</h2>
<div id="error" style="color:red; margin-bottom:10px;"></div>

<div class="room">
  <div class="room-title">ルーム1</div>
  <div class="room-info">
    人数（<span id="count-room1">0</span>人）
    <span id="names-room1">なし</span>
  </div>
  <button onclick="enterRoom('room1')">入室</button>
</div>

<div class="room">
  <div class="room-title">ルーム2</div>
  <div class="room-info">
    人数（<span id="count-room2">0</span>人）
    <span id="names-room2">なし</span>
  </div>
  <button onclick="enterRoom('room2')">入室</button>
</div>

<div class="room">
  <div class="room-title">スペシャル</div>
  <div class="room-info">
    人数（<span id="count-special">0</span>人）
    <span id="names-special">なし</span>
  </div>
  <button onclick="enterRoom('special')">入室</button>
</div>

<div class="room">
  <div class="room-title">個室A</div>
  <div class="room-info">
    人数（<span id="count-privateA">0</span>人）
    <span id="names-privateA">なし</span>
  </div>
  <input type="password" id="key-privateA" placeholder="鍵">
  <button onclick="enterRoom('privateA')">入室</button>
</div>

<div class="room">
  <div class="room-title">個室B</div>
  <div class="room-info">
    人数（<span id="count-privateB">0</span>人）
    <span id="names-privateB">なし</span>
  </div>
  <input type="password" id="key-privateB" placeholder="鍵">
  <button onclick="enterRoom('privateB')">入室</button>
</div>

<div class="room">
  <div class="room-title">個室C</div>
  <div class="room-info">
    人数（<span id="count-privateC">0</span>人）
    <span id="names-privateC">なし</span>
  </div>
  <input type="password" id="key-privateC" placeholder="鍵">
  <button onclick="enterRoom('privateC')">入室</button>
</div>

<div class="room">
  <div class="room-title">個室D</div>
  <div class="room-info">
    人数（<span id="count-privateD">0</span>人）
    <span id="names-privateD">なし</span>
  </div>
  <input type="password" id="key-privateD" placeholder="鍵">
  <button onclick="enterRoom('privateD')">入室</button>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();

socket.on("lobbyUpdate", rooms => {
  const allRooms = [
    "room1","room2","special",
    "privateA","privateB","privateC","privateD"
  ];

  allRooms.forEach(room => {
    const countEl = document.getElementById(`count-${room}`);
    const namesEl = document.getElementById(`names-${room}`);
    const btn = document.querySelector(`button[onclick="enterRoom('${room}')"]`);
    if (!countEl || !namesEl || !btn) return;

    const info = rooms[room];
    if (info) {
      countEl.textContent = info.count;
      namesEl.textContent = info.names.join(", ");
      if (room.startsWith("private") && info.count >= 2) {
        btn.disabled = true;
        btn.textContent = "満室";
      } else {
        btn.disabled = false;
        btn.textContent = "入室";
      }
    } else {
      countEl.textContent = 0;
      namesEl.textContent = "なし";
      btn.disabled = false;
      btn.textContent = "入室";
    }
  });
});

function enterRoom(room) {
  const errorEl = document.getElementById("error");
  errorEl.textContent = "";

  let key = "";
  if (room.startsWith("private")) {
    key = document.getElementById(`key-${room}`)?.value || "";
  }

  socket.emit("checkRoomKey", { room, key });

  socket.off("checkResult");   // ← 多重防止
  socket.on("checkResult", res => {
    if (!res.ok) {
      errorEl.textContent = res.message || "入室できません";
      return;
    }

    localStorage.setItem("chatRoom", room);
    localStorage.setItem("chatKey", key);
    location.href = "/";
  });
}

</script>

</body>
</html>
